const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CznVvx6g-1765654395898.js","assets/index-BgI8nqHP-1765654395898.css"])))=>i.map(i=>d[i]);
import{c as oe,d as b,t as R,r as f,u as ce,o as de,j as t,A as me,m as O,N as ue,_ as xe}from"./index-CznVvx6g-1765654395898.js";import{u as fe}from"./useTranslation-CJ_f5DPn-1765654395898.js";import{L as G}from"./loader-circle-CU6mFSiQ-1765654395898.js";import{X as pe}from"./x-CnpDAG73-1765654395898.js";import{H as J}from"./heart-CETWKSaP-1765654395898.js";import{T as Q}from"./trash-2-Pex7Dso8-1765654395898.js";import{F as X}from"./flag-DnZRpib_-1765654395898.js";const he=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]],Z=oe("ellipsis",he);async function ge(i,m){const{data:n,error:h}=await b.from("comments").select("*, user:users!user_id(*)").eq("post_id",i).is("parent_id",null).order("created_at",{ascending:!1});if(h||!n)return[];let s=new Set;if(m){const{data:d}=await b.from("comment_likes").select("comment_id").eq("user_id",m);s=new Set(d?.map(r=>r.comment_id)||[])}return await Promise.all(n.map(async d=>{const{data:r}=await b.from("comments").select("*, user:users!user_id(*)").eq("parent_id",d.id).order("created_at",{ascending:!0});return{...d,liked:s.has(d.id),replies:(r||[]).map(x=>({...x,liked:s.has(x.id)}))}}))}async function be(i,m,n,h){const{data:s,error:c}=await b.from("comments").insert({post_id:i,user_id:m,content:n,parent_id:h||null}).select("*, user:users!user_id(*)").single();if(c)return console.error("Add comment error:",c),R.error("Failed to add comment"),null;await b.rpc("increment_comments",{p_post_id:i});const{data:d}=await b.from("posts").select("creator_id").eq("id",i).single();return d&&d.creator_id!==m&&await b.from("notifications").insert({user_id:d.creator_id,from_user_id:m,type:"comment",content:"commented on your post",reference_id:i.toString(),reference_type:"post"}),s}async function we(i,m,n){await b.from("comments").delete().eq("parent_id",i);const{error:h}=await b.from("comments").delete().eq("id",i).eq("user_id",m);return h||await b.rpc("decrement_comments",{p_post_id:n}),!h}async function ve(i,m){const{error:n}=await b.from("comment_likes").insert({comment_id:i,user_id:m});return!n}async function _e(i,m){const{error:n}=await b.from("comment_likes").delete().eq("comment_id",i).eq("user_id",m);return!n}function je(i,m){const n=typeof m=="function"?{onInsert:m}:m,h=b.channel(`comments:${i}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"comments",filter:`post_id=eq.${i}`},async s=>{const{data:c}=await b.from("comments").select("*, user:users!user_id(*)").eq("id",s.new.id).single();c&&n.onInsert&&n.onInsert(c)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"comments",filter:`post_id=eq.${i}`},async s=>{const{data:c}=await b.from("comments").select("*, user:users!user_id(*)").eq("id",s.new.id).single();c&&n.onUpdate&&n.onUpdate(c)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"comments",filter:`post_id=eq.${i}`},s=>{n.onDelete&&n.onDelete(s.old.id)}).subscribe();return()=>{b.removeChannel(h)}}function ye(i,m){const[n,h]=f.useState(!1),[s,c]=f.useState(null);return{uploadComment:f.useCallback(async(r,x)=>{if(!i||!r.trim()||n)return null;h(!0),c(null);try{return await be(i,m,r.trim(),x)}catch(g){const _=g instanceof Error?g.message:"Failed to post comment";return console.error("Error uploading comment:",g),c(_),null}finally{h(!1)}},[i,m,n]),isLoading:n,error:s}}function ke(){const[i,m]=f.useState(!1),n=f.useCallback(async(s,c,d)=>{if(i)return;m(!0);const r=s.liked??!1,x=s.likes_count??0,g=!r,_=g?x+1:Math.max(0,x-1);d?.(g,_);try{r?await ce(c,s.id):await de(c,s.id)}catch(k){console.error("Error updating post like:",k),d?.(r,x)}finally{m(!1)}},[i]),h=f.useCallback(async(s,c,d)=>{if(i)return;m(!0);const r=s.liked??!1,x=s.likes_count??0,g=!r,_=g?x+1:Math.max(0,x-1);d?.(g,_);try{r?await _e(s.id,c):await ve(s.id,c)}catch(k){console.error("Error updating comment like:",k),d?.(r,x)}finally{m(!1)}},[i]);return{handlePostLike:n,handleCommentLike:h,loading:i}}function Ne(i=!0){const[m,n]=f.useState({visible:!1,height:0}),h=f.useRef(0),s=f.useRef(null),c=f.useCallback(()=>{if(!i)return;const d=window.visualViewport,r=window.Telegram?.WebApp;let x=0;if(d&&(x=Math.max(0,window.innerHeight-d.height-d.offsetTop)),r?.viewportHeight&&r?.viewportStableHeight){const g=Math.max(0,r.viewportStableHeight-r.viewportHeight);x=Math.max(x,g)}Math.abs(x-h.current)>20&&(h.current=x,n({visible:x>100,height:x}))},[i]);return f.useEffect(()=>{if(!i)return;const d=()=>{s.current!==null&&cancelAnimationFrame(s.current),s.current=requestAnimationFrame(c)},r=window.Telegram?.WebApp;return window.visualViewport?.addEventListener("resize",d),window.visualViewport?.addEventListener("scroll",d),r?.onEvent?.("viewportChanged",d),c(),()=>{window.visualViewport?.removeEventListener("resize",d),window.visualViewport?.removeEventListener("scroll",d),r?.offEvent?.("viewportChanged",d),s.current!==null&&cancelAnimationFrame(s.current)}},[i,c]),m}const Ce=["â¤ï¸","ðŸ™Œ","ðŸ”¥","ðŸ‘","ðŸ˜¢","ðŸ˜","ðŸ˜®","ðŸ˜‚"],Y=4;function He({isOpen:i,onClose:m,postId:n,postCreatorId:h,user:s}){const{t:c}=fe(),[d,r]=f.useState([]),[x,g]=f.useState(""),[_,k]=f.useState(!0),[N,C]=f.useState(null),[I,L]=f.useState({}),[M,F]=f.useState(!1),[E,j]=f.useState(null),[S,$]=f.useState(null),w=f.useRef(null),A=f.useRef(null),T=f.useRef(null),q=Ne(i),{uploadComment:ee,isLoading:D}=ye(n,s.telegram_id),{handleCommentLike:te}=ke();f.useEffect(()=>{if(i&&n){se();const e=je(n,{onInsert:a=>{a.user_id!==s.telegram_id&&(a.parent_id?r(u=>u.map(o=>o.id===a.parent_id?{...o,replies:[...o.replies||[],a]}:o)):r(u=>[a,...u]))},onUpdate:a=>{r(u=>u.map(o=>o.id===a.id?{...o,likes_count:a.likes_count}:o.replies?.some(l=>l.id===a.id)?{...o,replies:o.replies.map(l=>l.id===a.id?{...l,likes_count:a.likes_count}:l)}:o))},onDelete:a=>{r(u=>u.filter(l=>l.id!==a).map(l=>({...l,replies:(l.replies||[]).filter(p=>p.id!==a)})))}});return()=>e()}else r([]),g(""),C(null),L({}),j(null)},[i,n]);const se=async()=>{if(!n)return;k(!0);const e=await ge(n,s.telegram_id);r(e),k(!1)},ie=e=>{g(e.target.value),e.target.style.height="auto",e.target.style.height=`${Math.min(e.target.scrollHeight,80)}px`};f.useEffect(()=>{q.visible&&T.current&&T.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[q.visible]);const ne=e=>{g(a=>a+e),w.current?.focus()},y=f.useRef(null),P=async()=>{if(!x.trim()||D||!n)return;const e=x.trim(),a=N?.id,u=N;y.current&&(y.current.style.transition="none",y.current.style.paddingBottom="calc(env(safe-area-inset-bottom, 0px) + 12px)"),F(!0),w.current?.blur(),g(""),C(null),w.current&&(w.current.style.height="auto"),setTimeout(()=>{F(!1),y.current&&(y.current.style.transition="",y.current.style.paddingBottom="")},600);const o=await ee(e,a);o&&(u?r(l=>l.map(p=>{if(p.id===u.id){const v=[...p.replies||[],o];return L(H=>({...H,[p.id]:v.length})),{...p,replies:v}}return p})):(r(l=>[o,...l]),requestAnimationFrame(()=>{A.current?.scrollTo({top:0,behavior:"smooth"})})))},z=e=>{te(e,s.telegram_id,(a,u)=>{const o=l=>l.id===e.id?{...l,liked:a,likes_count:u}:l.replies?{...l,replies:l.replies.map(o)}:l;r(l=>l.map(o))})},V=e=>e.user_id===s.telegram_id||h===s.telegram_id,K=async e=>{if(!n)return;$(e.id),j(null);const a=h===s.telegram_id,u=e.user_id===s.telegram_id;let o=!1;if(u)o=await we(e.id,s.telegram_id,n);else if(a){const{supabase:l}=await xe(async()=>{const{supabase:v}=await import("./index-CznVvx6g-1765654395898.js").then(H=>H.aG);return{supabase:v}},__vite__mapDeps([0,1]));await l.from("comments").delete().eq("parent_id",e.id);const{error:p}=await l.from("comments").delete().eq("id",e.id);p||(await l.rpc("decrement_comments",{p_post_id:n}),o=!0)}o?(e.parent_id?r(l=>l.map(p=>p.id===e.parent_id?{...p,replies:(p.replies||[]).filter(v=>v.id!==e.id)}:p)):r(l=>l.filter(p=>p.id!==e.id)),R.success("Comment deleted")):R.error("Failed to delete comment"),$(null)},U=e=>{j(null),R.success("Comment reported")},W=e=>{const a=Date.now()-new Date(e).getTime(),u=Math.floor(a/6e4);if(u<1)return"now";if(u<60)return`${u}m`;const o=Math.floor(u/60);return o<24?`${o}h`:`${Math.floor(o/24)}d`},B=(e,a)=>I[e]??Math.min(Y,a),re=(e,a)=>{const u=B(e,a);L(o=>({...o,[e]:Math.min(u+Y,a)}))},ae=(e,a)=>t.jsxs("div",{className:"flex gap-1.5 mt-2 relative",children:[t.jsx("img",{src:e.user?.avatar_url||`https://i.pravatar.cc/150?u=${e.user_id}`,alt:"",className:"w-5 h-5 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{children:[t.jsx("span",{className:"font-semibold text-[12px] text-white mr-1",children:e.user?.username||e.user?.first_name}),t.jsx("span",{className:"text-[12px] text-white/85 leading-snug whitespace-pre-wrap break-words",children:e.content})]}),t.jsxs("div",{className:"flex items-center gap-3 mt-0.5",children:[t.jsx("span",{className:"text-[10px] text-gray-500",children:W(e.created_at)}),t.jsx("button",{className:"text-[10px] font-semibold text-gray-500 active:text-gray-300",onClick:()=>{C(a),w.current?.focus()},children:"Reply"}),t.jsxs("button",{onClick:()=>z(e),className:"flex items-center gap-1 active:scale-95 transition-transform",children:[t.jsx(J,{className:`w-3 h-3 ${e.liked?"fill-red-500 text-red-500":"text-gray-500"}`}),(e.likes_count||0)>0&&t.jsx("span",{className:`text-[10px] font-medium ${e.liked?"text-red-500":"text-gray-500"}`,children:e.likes_count})]})]})]}),t.jsx("div",{className:"flex items-start pt-0.5",children:t.jsx("button",{onClick:()=>j(E===e.id?null:e.id),className:"active:scale-90 transition-transform p-0.5",children:t.jsx(Z,{className:"w-3 h-3 text-gray-500"})})}),E===e.id&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>j(null)}),t.jsxs("div",{className:"absolute right-0 top-6 bg-[#262626] rounded-lg shadow-xl z-20 overflow-hidden min-w-[140px] border border-white/10",children:[V(e)&&t.jsxs("button",{onClick:()=>K(e),disabled:S===e.id,className:"w-full flex items-center gap-2 px-4 py-2.5 text-red-500 hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(Q,{className:"w-4 h-4"}),S===e.id?"Deleting...":"Delete"]}),t.jsxs("button",{onClick:()=>U(),className:"w-full flex items-center gap-2 px-4 py-2.5 text-white hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(X,{className:"w-4 h-4"}),"Report"]})]})]})]},e.id),le=e=>{const a=e.replies||[],u=a.length,o=B(e.id,u),l=a.slice(0,o),p=u-o;return t.jsxs("div",{className:"mt-3 first:mt-0 relative",children:[t.jsxs("div",{className:"flex gap-2.5",children:[t.jsx("img",{src:e.user?.avatar_url||`https://i.pravatar.cc/150?u=${e.user_id}`,alt:"",className:"w-8 h-8 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"flex items-start gap-2",children:t.jsxs("div",{className:"flex-1",children:[t.jsx("span",{className:"font-semibold text-[13px] text-white mr-1.5",children:e.user?.username||e.user?.first_name}),t.jsx("span",{className:"text-[13px] text-white/90 leading-snug whitespace-pre-wrap break-words",children:e.content})]})}),t.jsxs("div",{className:"flex items-center gap-3 mt-1",children:[t.jsx("span",{className:"text-[11px] text-gray-500",children:W(e.created_at)}),t.jsx("button",{className:"text-[11px] font-semibold text-gray-500 active:text-gray-300",onClick:()=>{C(e),w.current?.focus()},children:"Reply"}),t.jsxs("button",{onClick:()=>z(e),className:"flex items-center gap-1 active:scale-95 transition-transform",children:[t.jsx(J,{className:`w-3.5 h-3.5 ${e.liked?"fill-red-500 text-red-500":"text-gray-500"}`}),(e.likes_count||0)>0&&t.jsx("span",{className:`text-[11px] font-semibold ${e.liked?"text-red-500":"text-gray-500"}`,children:e.likes_count})]})]})]}),t.jsx("div",{className:"flex items-start pt-1",children:t.jsx("button",{onClick:()=>j(E===e.id?null:e.id),className:"active:scale-90 transition-transform p-0.5",children:t.jsx(Z,{className:"w-3.5 h-3.5 text-gray-500"})})})]}),E===e.id&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>j(null)}),t.jsxs("div",{className:"absolute right-0 top-8 bg-[#262626] rounded-lg shadow-xl z-20 overflow-hidden min-w-[140px] border border-white/10",children:[V(e)&&t.jsxs("button",{onClick:()=>K(e),disabled:S===e.id,className:"w-full flex items-center gap-2 px-4 py-2.5 text-red-500 hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(Q,{className:"w-4 h-4"}),S===e.id?"Deleting...":"Delete"]}),t.jsxs("button",{onClick:()=>U(),className:"w-full flex items-center gap-2 px-4 py-2.5 text-white hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(X,{className:"w-4 h-4"}),"Report"]})]})]}),u>0&&t.jsxs("div",{className:"ml-10 mt-1.5",children:[l.map(v=>ae(v,e)),p>0&&t.jsxs("button",{onClick:()=>re(e.id,u),className:"flex items-center gap-2 mt-2 text-[11px] font-semibold text-gray-500 active:text-gray-300",children:[t.jsx("div",{className:"w-5 h-px bg-gray-600"}),"View ",p," more ",p===1?"reply":"replies"]})]})]},e.id)};return t.jsx(me,{mode:"sync",children:i&&t.jsxs(t.Fragment,{children:[t.jsx(O.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-black/70 backdrop-blur-[2px] z-[9998]",onClick:()=>{w.current?.blur(),m()}}),t.jsxs(O.div,{ref:y,initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"tween",duration:.18,ease:[.32,.72,0,1]},className:"fixed inset-x-0 bottom-0 z-[9999] bg-[#0c0c0c] rounded-t-[16px] flex flex-col overflow-hidden will-change-transform shadow-[0_-14px_60px_rgba(0,0,0,0.45)] border border-white/5 border-b-0",style:{height:"calc(var(--app-height) - 96px)",maxHeight:"calc(var(--app-height) - 72px)",paddingBottom:M?"calc(env(safe-area-inset-bottom, 0px) + 12px)":q.visible?"calc(var(--keyboard-height) + env(safe-area-inset-bottom, 0px) + 10px)":"calc(env(safe-area-inset-bottom, 0px) + 12px)",transition:M?"none":"padding-bottom 0.08s linear",transform:"translateZ(0)"},children:[t.jsx("div",{className:"flex justify-center pt-3 pb-2 cursor-pointer flex-shrink-0",onClick:m,children:t.jsx("div",{className:"w-9 h-1 bg-[#555] rounded-full"})}),t.jsx("div",{className:"text-center pb-3 border-b border-[#1f1f1f] flex-shrink-0",children:t.jsx("h3",{className:"font-semibold text-white text-base tracking-tight",children:c("feed.commentsSheet.title")})}),t.jsx("div",{ref:A,className:"flex-1 overflow-y-auto px-4 overscroll-contain",style:{minHeight:0,background:"linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0))"},children:_?t.jsx("div",{className:"flex justify-center py-12",children:t.jsx(G,{className:"w-6 h-6 animate-spin text-gray-400"})}):d.length===0?t.jsxs("div",{className:"text-center py-16",children:[t.jsx("div",{className:"w-20 h-20 bg-[#363636] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx(ue,{className:"w-10 h-10 text-gray-500"})}),t.jsx("h3",{className:"font-semibold text-white text-xl mb-2",children:c("feed.commentsSheet.noCommentsTitle")}),t.jsx("p",{className:"text-sm text-gray-500",children:c("feed.commentsSheet.noCommentsSubtitle")})]}):t.jsx("div",{className:"py-4",children:d.map(e=>le(e))})}),t.jsxs("div",{ref:T,className:"border-t border-[#1f1f1f] bg-[#0c0c0c] flex-shrink-0 pb-[env(safe-area-inset-bottom)]",children:[t.jsx("div",{className:"flex justify-around px-6 py-3",children:Ce.map(e=>t.jsx("button",{onClick:()=>ne(e),className:"text-[22px] active:scale-90 transition-transform",children:e},e))}),N&&t.jsxs("div",{className:"flex justify-between items-center px-4 py-2 bg-[#363636] mx-4 rounded-lg text-xs text-gray-400 mb-2",children:[t.jsxs("span",{children:[c("feed.commentsSheet.replyingTo")," ",t.jsx("span",{className:"font-semibold text-white",children:N.user?.username||"User"})]}),t.jsx("button",{onClick:()=>C(null),className:"p-1",children:t.jsx(pe,{className:"w-3.5 h-3.5"})})]}),t.jsxs("div",{className:"flex items-center gap-3 px-4 pb-3",children:[t.jsx("img",{src:s.avatar_url||`https://i.pravatar.cc/150?u=${s.telegram_id}`,alt:"",className:"w-9 h-9 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 flex items-center bg-[#151515] border border-[#2e2e2e] rounded-full px-4 py-2 focus-within:border-[#444] transition-colors",children:[t.jsx("textarea",{ref:w,value:x,onChange:ie,placeholder:c(N?"feed.commentsSheet.reply":"feed.commentsSheet.addComment"),rows:1,enterKeyHint:"send",className:"flex-1 bg-transparent text-white text-[15px] placeholder-[#888] focus:outline-none resize-none max-h-20",style:{minHeight:"22px"},onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),P())}}),x.trim()&&t.jsx("button",{onClick:P,disabled:D,className:"text-[#0095f6] font-semibold text-[15px] ml-2 disabled:opacity-50",children:D?t.jsx(G,{className:"w-5 h-5 animate-spin"}):c("feed.commentsSheet.post")})]})]})]})]})]})})}export{He as C,Z as E};
