import{s as a}from"./index-C37A893G-1765325408043.js";async function g(t,s,e){const{data:r}=await a.from("users").select("balance").eq("telegram_id",t).single();if(!r||r.balance<s)return{success:!1,error:"Insufficient token balance"};const{error:i}=await a.from("users").update({balance:r.balance-s}).eq("telegram_id",t);if(i)return{success:!1,error:i.message};const{data:n}=await a.from("transactions").insert({user_id:t,amount:-s,type:"payment",description:e,status:"completed"}).select().single();return{success:!0,transactionId:n?.id}}function v(t,s,e){const r=window.Telegram?.WebApp;if(!r){e();return}r.openInvoice(t,i=>{i==="paid"?s():e()})}async function p(t){try{const s={userId:t.fromUserId,creatorId:t.toUserId,referenceType:t.referenceType,referenceId:t.referenceId,amount:t.amount},{data:e,error:r}=await a.functions.invoke("create-order",{body:s});return r||!e?.ok||!e.invoiceUrl||!e.orderId?{success:!1,error:r?.message||e?.error||"Failed to create Stars invoice"}:{success:!0,invoiceUrl:e.invoiceUrl,transactionId:e.orderId}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Stars invoice error"}}}async function y(t){try{await a.functions.invoke("confirm-order",{body:{orderId:t}})}catch(s){console.warn("[Stars] confirm failed (will rely on webhook):",s)}}async function w(t){if(!window.Telegram?.WebApp)return{success:!1,error:"Telegram WebApp not available for Stars"};const e=await p(t);if(!e.success||!e.invoiceUrl||!e.transactionId)return{success:!1,error:e.error||"Could not create Stars invoice"};const r=e.invoiceUrl,i=e.transactionId;return await new Promise(n=>{v(r,async()=>{await y(i),n({success:!0,transactionId:String(i)})},()=>n({success:!1,error:"Payment cancelled"}))})}async function h(t,s,e,r,i,n){try{await a.from("tips").insert({from_user_id:t,to_user_id:s,amount:e,message:r,post_id:i,transaction_id:n?Number(n):null})}catch(c){console.warn("[Stars] record tip failed",c)}}async function b(t,s,e,r,i="tokens"){if(r<=0)return{success:!0};const{data:n}=await a.from("livestream_tickets").select("id").eq("livestream_id",e).eq("user_id",t).limit(1);if(n&&n.length>0)return{success:!0};if(i==="stars"){const _=await w({amount:r,fromUserId:t,toUserId:s,referenceType:"livestream",referenceId:e});if(!_.success)return _;const{error:m}=await a.from("livestream_tickets").insert({livestream_id:e,user_id:t,amount:r});return m?{success:!1,error:m.message}:(await a.from("creator_earnings").insert({creator_id:s,amount:r,source_type:"livestream",source_id:e,from_user_id:t,platform_fee:Math.ceil(r*.1),net_amount:Math.max(0,r-Math.ceil(r*.1))}),{success:!0,transactionId:_.transactionId})}const c=await g(t,r,`Livestream access for ${e}`);if(!c.success)return c;const{error:o}=await a.from("livestream_tickets").insert({livestream_id:e,user_id:t,amount:r});if(o)return await a.rpc("add_to_balance",{user_telegram_id:t,amount_to_add:r}),{success:!1,error:o.message};const u=Math.ceil(r*.1),l=Math.max(0,r-u);return await a.from("creator_earnings").insert({creator_id:s,amount:r,source_type:"livestream",source_id:e,from_user_id:t,platform_fee:u,net_amount:l}),l>0&&await a.rpc("add_to_balance",{user_telegram_id:s,amount_to_add:l}),{success:!0,transactionId:c.transactionId}}async function q(t,s,e,r="tokens",i,n){if(r==="stars"){const o=await w({amount:e,fromUserId:t,toUserId:s,referenceType:"tip",referenceId:String(s),metadata:{postId:n,message:i}});return o.success?(await h(t,s,e,i,n,o.transactionId),await a.from("notifications").insert({user_id:s,from_user_id:t,type:"tip",content:"sent you a tip"}),{success:!0,transactionId:o.transactionId}):o}const c=await g(t,e,`Tip to user ${s}`);return c.success?(await a.rpc("add_to_balance",{user_telegram_id:s,amount_to_add:Math.floor(e*.95)}),await a.from("notifications").insert({user_id:s,from_user_id:t,type:"tip",content:`sent you a $${e} tip!`}),{success:!0,transactionId:c.transactionId}):c}const k="81e67142488042efa6a00af94095db5e",d=60;async function L(t){const{data:s}=await a.from("streaming_usage").select("minutes_used").eq("user_id",t).eq("date",new Date().toISOString().split("T")[0]).single();return s?Math.max(0,d-s.minutes_used):d}async function M(t,s){const e=new Date().toISOString().split("T")[0],{data:r}=await a.from("streaming_usage").select("minutes_used").eq("user_id",t).eq("date",e).single();if(r){const i=r.minutes_used+s;return await a.from("streaming_usage").update({minutes_used:i,updated_at:new Date().toISOString()}).eq("user_id",t).eq("date",e),i}else return await a.from("streaming_usage").insert({user_id:t,date:e,minutes_used:s}),s}async function U(t,s,e){const r=`live_${t}_${Date.now()}`,{data:i,error:n}=await a.from("livestreams").insert({creator_id:t,title:s,description:e?.description,is_private:e?.is_private||!1,entry_price:e?.entry_price||0,thumbnail_url:e?.thumbnail_url||null,agora_channel:r,room_name:r,status:"live",started_at:new Date().toISOString()}).select("*, creator:users!creator_id(*)").single();return n?(console.error("Create livestream error:",n),null):i}async function D(t){const{error:s}=await a.from("livestreams").update({status:"ended",ended_at:new Date().toISOString()}).eq("id",t);return!s}async function S(){const{data:t}=await a.from("livestreams").select("*, creator:users!creator_id(*)").eq("status","live").order("started_at",{ascending:!1});return t||[]}async function f(t){const{data:s}=await a.from("livestreams").select("*, creator:users!creator_id(*)").eq("id",t).single();return s}async function $(t,s){let e=null;if(typeof t=="string"?e=await f(t):e=t,!e)return{can_watch:!1,requires_ticket:!1,has_ticket:!1,requires_subscription:!1,has_subscription:!1,entry_price:0,is_creator:!1,reason:"This stream is no longer available."};const r=e.creator_id===s,i=e.status==="live",n=!!e.is_private&&!r,c=(e.entry_price||0)>0&&!r;let o=!1;if(n){const{data:m}=await a.from("subscriptions").select("id").eq("subscriber_id",s).eq("creator_id",e.creator_id).eq("is_active",!0).limit(1);o=!!(m&&m.length>0)}let u=!1;if(c){const{data:m}=await a.from("livestream_tickets").select("id").eq("livestream_id",e.id).eq("user_id",s).limit(1);u=!!(m&&m.length>0)}let l;return!i&&!r?l="This stream is not live right now.":n&&!o?l="Subscribe to watch this stream.":c&&!u&&(l=`Unlock this stream for ${e.entry_price} tokens.`),{can_watch:r?!0:i&&(!n||o)&&(!c||u),requires_ticket:c,has_ticket:u,requires_subscription:n,has_subscription:o||r,entry_price:e.entry_price||0,is_creator:r,reason:l}}async function A(t,s){const e=await f(t);return e?b(s,e.creator_id,e.id,e.entry_price||0):{success:!1,error:"Livestream not found."}}async function C(t,s){await a.from("livestream_viewers").upsert({livestream_id:t,user_id:s,joined_at:new Date().toISOString(),is_currently_watching:!0});const{data:e}=await a.from("livestream_viewers").select("id").eq("livestream_id",t).eq("is_currently_watching",!0),r=e?.length||0,{data:i}=await a.from("livestreams").select("peak_viewers").eq("id",t).single();return await a.from("livestreams").update({viewer_count:r,peak_viewers:Math.max(i?.peak_viewers||0,r)}).eq("id",t),!0}async function E(t,s){await a.from("livestream_viewers").update({is_currently_watching:!1,left_at:new Date().toISOString()}).eq("livestream_id",t).eq("user_id",s);const{data:e}=await a.from("livestream_viewers").select("id").eq("livestream_id",t).eq("is_currently_watching",!0);await a.from("livestreams").update({viewer_count:e?.length||0}).eq("id",t)}async function R(t,s=100){const{data:e}=await a.from("livestream_messages").select("*, user:users!user_id(*), gift:gifts(*)").eq("livestream_id",t).eq("is_deleted",!1).order("created_at",{ascending:!0}).limit(s);return e||[]}async function x(t,s,e){const{data:r,error:i}=await a.from("livestream_messages").insert({livestream_id:t,user_id:s,content:e,message_type:"chat"}).select("*, user:users!user_id(*)").single();return i?null:r}async function P(t,s,e,r){const i=await f(t);if(!i)return{message:null,error:"Stream not found"};const n=await q(s,i.creator_id,r,"stars");if(!n.success)return{message:null,error:n.error||"Gift payment failed"};const{data:c}=await a.from("gifts").select("name, price").eq("id",e).single(),{data:o,error:u}=await a.from("livestream_messages").insert({livestream_id:t,user_id:s,content:`sent ${c?.name||"a gift"}`,message_type:"gift",gift_id:e}).select("*, user:users!user_id(*), gift:gifts(*)").single();return u?{message:null,error:u.message}:(await a.from("livestreams").update({total_gifts_received:(i.total_gifts_received||0)+(c?.price||r)}).eq("id",t),{message:o,error:null})}function W(t,s){const e=a.channel(`livestream_messages:${t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"livestream_messages",filter:`livestream_id=eq.${t}`},async r=>{const{data:i}=await a.from("livestream_messages").select("*, user:users!user_id(*), gift:gifts(*)").eq("id",r.new.id).single();i&&s(i)}).subscribe();return()=>{a.removeChannel(e)}}function O(t,s){const e=a.channel(`livestream_viewers:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"livestreams",filter:`id=eq.${t}`},r=>{s(r.new.viewer_count||0)}).subscribe();return()=>{a.removeChannel(e)}}function N(t){const s=a.channel("livestreams:lobby").on("postgres_changes",{event:"*",schema:"public",table:"livestreams"},async e=>{const r=e.eventType,i=e.new?.status,n=e.old?.status;if(!(r==="DELETE"||r==="INSERT"&&i==="live"||r==="UPDATE"&&(i==="live"||n==="live")))return;const o=await S();t(o)}).subscribe();return()=>{a.removeChannel(s)}}export{k as A,M as a,L as b,f as c,$ as d,R as e,D as f,S as g,W as h,O as i,C as j,U as k,E as l,x as m,P as n,A as p,N as s};
