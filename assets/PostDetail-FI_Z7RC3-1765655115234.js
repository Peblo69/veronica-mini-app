import{c as K,ah as Q,r,ai as Z,j as e,m as k,A as $,u as F,o as ee,q as te,p as se,aj as ae,k as ie}from"./index-DdyL7W5o-1765655115234.js";import{P as ne,a as le,b as oe,c as re,d as ce,V as de}from"./PixelIcons-DPoImJAu-1765655115234.js";import{E as me,C as ue}from"./CommentsSheet-e65v3cDp-1765655115234.js";import{u as xe}from"./useTranslation-B6SSswy--1765655115234.js";import{A as he}from"./arrow-left-ila46-Ld-1765655115234.js";import{T as W}from"./trash-2-BOqXesU_-1765655115234.js";import{C as fe}from"./useInViewport-CZQv3KRF-1765655115234.js";import{L as pe}from"./lock-BQMUFKqu-1765655115234.js";import{L as V}from"./loader-circle-B63P42hp-1765655115234.js";import{V as be}from"./volume-2-CnLngdM9-1765655115234.js";import{H as we}from"./heart-DmMk4zJh-1765655115234.js";const ge=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],je=K("pen",ge),ve="https://eigfbxjheuwxmtdfnvqc.supabase.co/functions/v1/payments";async function _(s){const a=Q();return a?.accessToken?(await fetch(ve,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.accessToken}`},body:JSON.stringify(s)})).json():{error:"Not authenticated - please log in again"}}async function ye(s,a){return _({action:"create_unlock_invoice",user_id:s,post_id:a})}async function Ne(s,a,d,u,i){return _({action:"create_tip_invoice",user_id:s,to_user_id:a,amount:d,message:u,post_id:i})}async function We(s){return _({action:"get_wallet",user_id:s})}async function ke(s,a){return _({action:"check_purchase",user_id:s,post_id:a})}function z(s,a,d,u){const i=window.Telegram?.WebApp;if(!i){console.error("Telegram WebApp not available"),d?.();return}i.openInvoice(s,n=>{switch(console.log("Invoice status:",n),n){case"paid":a?.();break;case"cancelled":case"failed":d?.();break;case"pending":u?.();break;default:console.log("Unknown invoice status:",n)}})}async function Ve(s,a,d,u){try{const i=await ye(s,a);if(i.error){u?.(i.error);return}if(!i.invoice_link){u?.("Failed to create invoice");return}z(i.invoice_link,async()=>{let n=!1;for(let t=0;t<10;t++)if(await new Promise(p=>setTimeout(p,500)),(await ke(s,a)).purchased){n=!0;break}n||console.warn("[Payment] Purchase not verified yet, but Telegram confirmed payment"),d?.()},()=>u?.("Payment was cancelled"),()=>console.log("Payment pending..."))}catch(i){console.error("Unlock payment error:",i),u?.("An error occurred")}}async function ze(s,a,d,u,i,n,t){try{const m=await Ne(s,a,d,u,i);if(m.error){t?.(m.error);return}if(!m.invoice_link){t?.("Failed to create invoice");return}z(m.invoice_link,n,()=>t?.("Payment was cancelled"),()=>console.log("Payment pending..."))}catch(m){console.error("Tip payment error:",m),t?.("An error occurred")}}function _e({urls:s,muted:a,onMuteChange:d,onDoubleTap:u}){const[i,n]=r.useState(0),t=r.useRef(null),m=r.useRef(null),[p,f]=r.useState(!1),b=r.useRef(0),w=()=>{if(!t.current)return;const o=t.current.scrollLeft,x=t.current.offsetWidth,h=Math.round(o/x);h!==i&&n(h)},v=()=>{const o=Date.now();o-b.current<300&&(u?.(),f(!0),setTimeout(()=>f(!1),500)),b.current=o},g=o=>o.match(/\.(mp4|webm|mov|m4v)(\?|$)/i);return s.length===0?null:e.jsxs("div",{className:"relative w-full bg-black",children:[e.jsx("div",{ref:t,className:"flex w-full overflow-x-auto snap-x snap-mandatory scrollbar-hide",onScroll:w,style:{scrollbarWidth:"none",msOverflowStyle:"none"},onClick:v,children:s.map((o,x)=>e.jsx("div",{className:"flex-none w-full snap-center flex items-center justify-center min-h-[220px] max-h-[50vh]",children:g(o)?e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("video",{ref:x===i?m:void 0,src:o,controls:!1,playsInline:!0,loop:!0,muted:a,autoPlay:i===x,preload:"auto",className:"w-full max-h-[50vh] object-contain bg-black"}),e.jsx("button",{onClick:h=>{h.stopPropagation(),d?.(!a)},className:"absolute bottom-3 right-3 p-2 bg-black/70 rounded-full",children:a?e.jsx(de,{className:"w-5 h-5 text-white"}):e.jsx(be,{className:"w-5 h-5 text-white"})})]}):e.jsx("img",{src:o,alt:"",loading:"eager",className:"w-full max-h-[50vh] object-contain bg-black select-none"})},x))}),p&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx(we,{className:"w-16 h-16 text-white fill-white opacity-90 animate-ping"})}),s.length>1&&e.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1.5 z-10",children:s.map((o,x)=>e.jsx("div",{className:`w-1.5 h-1.5 rounded-full transition-all ${x===i?"bg-white":"bg-white/40"}`},x))}),s.length>1&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/70 text-white text-[10px] px-2 py-0.5 rounded-full z-10 font-medium",children:[i+1,"/",s.length]})]})}function Re({post:s,user:a,onBack:d,onDeleted:u,onUpdated:i}){const{t:n}=xe(),[t,m]=r.useState(s),[p,f]=r.useState(!1),[b,w]=r.useState(!1),[v,g]=r.useState(!1),[o,x]=r.useState(s.content||""),[h,R]=r.useState(s.visibility),[C,S]=r.useState(!1),[T,D]=r.useState(!1),[H,y]=r.useState(!1),[I,j]=r.useState(null),[O,U]=r.useState(!0),q=Number(s.creator_id)===Number(a.telegram_id);r.useEffect(()=>{Z(a.telegram_id,s.id).catch(()=>{})},[s.id,a.telegram_id]);const M=t.media_urls&&t.media_urls.length>0?t.media_urls:t.media_url?[t.media_url]:[],A=async()=>{t.liked?(await F(a.telegram_id,t.id),m(l=>{const c={...l,liked:!1,likes_count:Math.max(0,(l.likes_count||0)-1)};return i?.(c),c})):(await ee(a.telegram_id,t.id),m(l=>{const c={...l,liked:!0,likes_count:(l.likes_count||0)+1};return i?.(c),c}))},B=async()=>{t.saved?(await te(a.telegram_id,t.id),m(l=>{const c={...l,saved:!1};return i?.(c),c})):(await se(a.telegram_id,t.id),m(l=>{const c={...l,saved:!0};return i?.(c),c}))},J=async()=>{if(!o.trim())return;D(!0);const{data:l,error:c}=await ae(t.id,a.telegram_id,{content:o,visibility:h});l&&!c&&(m(E=>({...E,content:o,visibility:h})),g(!1),i?.({...t,content:o,visibility:h})),D(!1)},X=async()=>{S(!0),j(null);try{const{success:l}=await ie(t.id,t.creator_id);l?(y(!1),u?.(),d()):j("Unable to delete post. Please try again.")}catch{j("Something went wrong. Please try again.")}S(!1)},Y=l=>{const c=new Date(l),G=new Date().getTime()-c.getTime(),N=Math.floor(G/6e4),P=Math.floor(N/60),L=Math.floor(P/24);return N<1?"now":N<60?`${N}m`:P<24?`${P}h`:L<7?`${L}d`:c.toLocaleDateString("en-US",{month:"short",day:"numeric"})};return e.jsxs(k.div,{className:"fixed inset-0 bg-black z-[100] flex flex-col",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15},children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-black",style:{paddingTop:"max(60px, calc(env(safe-area-inset-top, 0px) + 50px))"},children:[e.jsxs("button",{onClick:d,className:"flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors",children:[e.jsx(he,{className:"w-5 h-5 text-white"}),e.jsx("span",{className:"text-white text-sm font-medium",children:n("common.back")})]}),q?e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>w(!b),className:"p-2 hover:bg-white/10 rounded-full transition-colors",children:e.jsx(me,{className:"w-5 h-5 text-white"})}),e.jsx($,{children:b&&e.jsxs(k.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.1},className:"absolute right-0 top-10 bg-[#1c1c1e] shadow-xl rounded-xl py-1 z-20 min-w-[120px] border border-white/10",children:[e.jsxs("button",{onClick:()=>{g(!0),w(!1)},className:"w-full px-3 py-2 text-left text-sm hover:bg-white/10 flex items-center gap-2 text-white",children:[e.jsx(je,{className:"w-4 h-4"})," ",n("feed.actions.edit")]}),e.jsxs("button",{onClick:()=>{y(!0),w(!1)},className:"w-full px-3 py-2 text-left text-sm text-red-400 hover:bg-red-500/10 flex items-center gap-2",children:[e.jsx(W,{className:"w-4 h-4"})," ",n("feed.actions.delete")]})]})})]}):e.jsx("div",{className:"w-10"})]}),e.jsxs("div",{className:"flex items-center gap-3 px-4 pb-2",children:[e.jsx("img",{src:t.creator?.avatar_url||`https://i.pravatar.cc/150?u=${t.creator_id}`,alt:"",className:"w-9 h-9 rounded-full object-cover border border-white/10"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"font-semibold text-sm text-white",children:t.creator?.username||"Creator"}),t.creator?.is_verified&&e.jsx(fe,{className:"w-3.5 h-3.5 text-blue-400 fill-blue-400"}),t.visibility!=="public"&&e.jsx(pe,{className:"w-3 h-3 text-white/50"})]}),e.jsx("span",{className:"text-white/50 text-xs",children:Y(t.created_at)})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto bg-black",children:[M.length>0&&e.jsx(_e,{urls:M,muted:O,onMuteChange:U,onDoubleTap:A}),!v&&t.content&&e.jsx("p",{className:"px-4 py-2 text-sm leading-relaxed text-white/90 whitespace-pre-wrap",children:t.content}),v&&e.jsxs("div",{className:"p-3 space-y-2 bg-[#0a0a0a] border-y border-white/5",children:[e.jsx("textarea",{value:o,onChange:l=>x(l.target.value),className:"w-full p-2 border border-white/10 rounded-lg min-h-[80px] focus:outline-none focus:border-white/20 bg-black text-xs text-white placeholder-white/30",placeholder:"What's on your mind?"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:h,onChange:l=>R(l.target.value),className:"px-2 py-1.5 border border-white/10 rounded-lg bg-black text-xs text-white outline-none",children:[e.jsx("option",{value:"public",children:n("create.visibility.public")}),e.jsx("option",{value:"followers",children:n("create.visibility.followers")}),e.jsx("option",{value:"subscribers",children:n("create.visibility.subscribers")})]}),e.jsxs("div",{className:"flex-1 flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>g(!1),className:"px-3 py-1.5 border border-white/10 rounded-lg text-xs font-medium hover:bg-white/5 transition-colors text-white",children:n("common.cancel")}),e.jsx("button",{onClick:J,disabled:T,className:"px-3 py-1.5 bg-blue-500 text-white rounded-lg text-xs font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center min-w-[50px]",children:T?e.jsx(V,{className:"w-3 h-3 animate-spin"}):n("common.save")})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/5",children:[e.jsxs("div",{className:"flex items-center gap-5",children:[e.jsxs("button",{onClick:A,className:`flex items-center gap-1.5 transition-colors ${t.liked?"text-red-500":"text-white/70"}`,children:[e.jsx(ne,{className:`w-6 h-6 ${t.liked?"scale-110":""}`,filled:t.liked}),e.jsx("span",{className:"text-sm font-medium",children:t.likes_count||0})]}),e.jsxs("button",{onClick:()=>f(!0),className:"flex items-center gap-1.5 text-white/70",children:[e.jsx(le,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm font-medium",children:t.comments_count||0})]}),e.jsx("button",{className:"text-white/70",children:e.jsx(oe,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:B,className:`transition-colors ${t.saved?"text-blue-400":"text-white/70"}`,children:e.jsx(re,{className:"w-6 h-6",filled:t.saved})}),e.jsxs("button",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:`w-6 h-6 ${(t.gifts_count||0)>0?"text-yellow-400":"text-white/70"}`,filled:(t.gifts_count||0)>0}),(t.gifts_count||0)>0&&e.jsx("span",{className:"text-xs font-bold text-yellow-400",children:t.gifts_count})]})]})]}),e.jsx("button",{onClick:()=>f(!0),className:"w-full px-4 py-3 text-left",children:t.comments_count>0?e.jsx("span",{className:"text-white/50 text-sm font-medium",children:n("feed.viewComments",{count:t.comments_count})}):e.jsx("span",{className:"text-white/50 text-sm",children:n("feed.addComment")})})]}),e.jsx(ue,{isOpen:p,onClose:()=>f(!1),postId:t.id,postCreatorId:t.creator_id,user:a}),e.jsx($,{children:H&&e.jsx(k.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15},className:"fixed inset-0 bg-black/80 flex items-center justify-center z-[120] p-4",onClick:()=>{y(!1),j(null)},children:e.jsxs(k.div,{initial:{scale:.95},animate:{scale:1},exit:{scale:.95},transition:{duration:.15},className:"bg-[#1c1c1e] rounded-2xl p-5 max-w-xs w-full border border-white/10",onClick:l=>l.stopPropagation(),children:[e.jsx("div",{className:"w-10 h-10 bg-red-500/10 rounded-full flex items-center justify-center mb-3 mx-auto",children:e.jsx(W,{className:"w-5 h-5 text-red-400"})}),e.jsx("h3",{className:"text-base font-bold mb-1.5 text-center text-white",children:n("postDetail.deleteTitle")}),e.jsx("p",{className:"text-white/50 mb-3 text-center text-xs",children:n("postDetail.deleteWarning")}),I&&e.jsx("div",{className:"mb-3 p-2 bg-red-500/10 border border-red-500/20 rounded-xl",children:e.jsx("p",{className:"text-red-400 text-xs text-center",children:I})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{y(!1),j(null)},className:"flex-1 py-2 border border-white/10 rounded-xl font-medium text-white text-sm",disabled:C,children:n("common.cancel")}),e.jsx("button",{onClick:X,disabled:C,className:"flex-1 py-2 bg-red-500 text-white rounded-xl font-semibold text-sm flex items-center justify-center disabled:opacity-50",children:C?e.jsx(V,{className:"w-4 h-4 animate-spin"}):n("common.delete")})]})]})})})]})}export{Re as P,We as g,ze as s,Ve as u};
