import{r as o,o as te,p as se,q as D,j as e,A as V,m as T,T as ie,X as H,t as ae,v as le,w as re,x as ne}from"./index-CdOqJoX2-1765314917368.js";import{m as ce,C as oe,a as de}from"./moderation-DZn-1LBV-1765314917368.js";import{P as me}from"./play-BytsTGNw-1765314917368.js";import{I as he}from"./image-BnWvQYor-1765314917368.js";import{C as xe}from"./camera-CVX5SNqm-1765314917368.js";import{E as ue}from"./ellipsis-B8pQz2uu-1765314917368.js";import{L as fe}from"./loader-circle-lrfYvust-1765314917368.js";import{G as q}from"./globe-DZvFLtDu-1765314917368.js";import{U as G}from"./users-DjTPvDuT-1765314917368.js";import{S as X}from"./star-B61s9OB1-1765314917368.js";function pe(t){return new Promise(r=>{const i=document.createElement("img");i.onload=()=>{r({width:i.naturalWidth,height:i.naturalHeight,sizeBytes:t.size}),URL.revokeObjectURL(i.src)},i.onerror=()=>{r({width:0,height:0,sizeBytes:t.size})},i.src=URL.createObjectURL(t)})}function be(t){return new Promise(r=>{const i=document.createElement("video");i.preload="metadata",i.onloadedmetadata=()=>{r({width:i.videoWidth,height:i.videoHeight,duration:Math.round(i.duration),sizeBytes:t.size}),URL.revokeObjectURL(i.src)},i.onerror=()=>{r({width:0,height:0,sizeBytes:t.size})},i.src=URL.createObjectURL(t)})}function Ce({user:t}){const[r,i]=o.useState(""),[m,w]=o.useState("public"),[J,M]=o.useState("public"),[C,P]=o.useState(!1),[S,p]=o.useState(null),[a,N]=o.useState([]),[we,g]=o.useState("idle"),[A,z]=o.useState(null),[W,k]=o.useState(!1),U=o.useRef(null),R=o.useRef(null),O=t.is_creator;o.useEffect(()=>{let s=!0;if(!O){M("public"),w("public");return}return te(t.telegram_id).then(c=>{if(!s||!c)return;const x=c.default_post_visibility||"public";M(x),w(x)}).catch(()=>{s&&(M("public"),w("public"))}),()=>{s=!1}},[t.telegram_id,O]),o.useEffect(()=>{R.current&&(R.current.style.height="auto",R.current.style.height=R.current.scrollHeight+"px")},[r]);const K=o.useCallback(async s=>{const c=Array.from(s.target.files||[]);if(c.length===0)return;const x=4-a.length,u=c.slice(0,x);for(const f of u){const b=se(f);if(b==="unknown")continue;g("checking"),z(null);const j=URL.createObjectURL(f);let v,y;if(b==="image")v=await pe(f);else if(b==="video"){v=await be(f);const d=await D(f);d&&(y={file:d,preview:URL.createObjectURL(d)})}const _={file:f,preview:j,type:b,metadata:v,thumbnail:y};try{{const d=b==="video"&&y?y.preview:j,l=await ce(d);if(l?.flagged){g("rejected");let n="This content violates our community guidelines.";l.categories?.sexual_minors?n="This content has been flagged for safety concerns and cannot be posted.":l.categories?.sexual?n="Adult/NSFW content is not allowed.":l.categories?.violence?n="Graphic violence is not allowed.":l.categories?.self_harm?n="Self-harm content is not allowed.":l.categories?.hate?n="Hate symbols or content is not allowed.":l.reasons?.length>0&&(n=l.reasons[0]),z(n),URL.revokeObjectURL(j);continue}}g("approved"),N(d=>[...d,_])}catch(d){console.error("Moderation check failed:",d),g("approved"),N(l=>[...l,_])}}U.current&&(U.current.value="")},[a.length]),Q=s=>{N(c=>{const x=[...c],u=x.splice(s,1)[0];return u&&(URL.revokeObjectURL(u.preview),u.thumbnail?.preview&&URL.revokeObjectURL(u.thumbnail.preview)),x}),a.length===1&&(g("idle"),z(null))},Y=async()=>{if(!(C||!r.trim()&&a.length===0)){P(!0),p({message:"Preparing...",percentage:0});try{if(r.trim()&&(await de(r.trim()))?.flagged){alert("Post blocked by moderation (unsafe text)."),P(!1),p(null);return}let s,c=[],x,u,f,b,j,v;if(a.length>0){const l=a.length;for(let n=0;n<a.length;n++){const h=a[n],I=n/l*80;let E=h.file;h.type==="image"&&(p({message:`Compressing ${n+1}/${l}...`,percentage:I+10}),E=await ae(E)),p({message:`Uploading ${n+1}/${l}...`,percentage:I+40});const L=await le(E,t.telegram_id);if(L.error){alert("Upload failed: "+L.error),P(!1),p(null);return}if(L.url&&(c.push(L.url),n===0&&(s=L.url,x=h.type==="other"?"image":h.type,f=h.metadata?.width,b=h.metadata?.height,j=h.metadata?.duration,v=h.metadata?.sizeBytes)),n===0&&h.type==="video"){let F=h.thumbnail?.file;if(F||(F=await D(h.file)??void 0),F){const $=await re(F,t.telegram_id);!$.error&&$.url&&(u=$.url)}}}}p({message:"Publishing...",percentage:90});const y=O?m:"public",_={content:r.trim(),media_url:s,media_urls:c.length>0?c:void 0,media_type:x,visibility:y,is_nsfw:!1,unlock_price:0,media_width:f,media_height:b,media_duration:j,media_size_bytes:v};u&&(_.media_thumbnail_url=u);const{error:d}=await ne(t.telegram_id,_);d?alert(`Failed to create post: ${d.message||"Please try again."}`):(p({message:"Posted!",percentage:100}),setTimeout(()=>{i(""),w(J),a.forEach(l=>{URL.revokeObjectURL(l.preview),l.thumbnail?.preview&&URL.revokeObjectURL(l.thumbnail.preview)}),N([]),g("idle"),p(null)},1e3))}catch(s){console.error("Post error:",s),alert("Something went wrong")}finally{P(!1)}}},Z=()=>m==="public"?"Anyone can reply":m==="followers"?"Followers can reply":"Subscribers can reply",ee=()=>m==="public"?e.jsx(q,{className:"w-4 h-4"}):m==="followers"?e.jsx(G,{className:"w-4 h-4"}):e.jsx(X,{className:"w-4 h-4"}),B=r.trim().length>0||a.length>0;return e.jsxs("div",{className:"min-h-screen bg-black text-white flex flex-col",children:[e.jsx("input",{ref:U,type:"file",accept:"image/*,video/*",multiple:!0,className:"hidden",onChange:K}),e.jsx(V,{children:S&&e.jsx(T.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/90 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"w-16 h-16 mx-auto mb-4 relative",children:[e.jsxs("svg",{className:"w-16 h-16 transform -rotate-90",children:[e.jsx("circle",{cx:"32",cy:"32",r:"28",stroke:"rgba(255,255,255,0.1)",strokeWidth:"4",fill:"none"}),e.jsx("circle",{cx:"32",cy:"32",r:"28",stroke:"white",strokeWidth:"4",fill:"none",strokeDasharray:175.9,strokeDashoffset:175.9-175.9*S.percentage/100,className:"transition-all duration-300"})]}),e.jsxs("span",{className:"absolute inset-0 flex items-center justify-center text-sm font-bold",children:[Math.round(S.percentage),"%"]})]}),e.jsx("p",{className:"text-white/60 text-sm",children:S.message})]})})}),e.jsx(V,{children:A&&e.jsxs(T.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"fixed top-4 left-4 right-4 z-40 bg-red-500/90 backdrop-blur-sm rounded-xl p-4 flex items-start gap-3",children:[e.jsx(ie,{className:"w-5 h-5 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-sm font-medium",children:A})}),e.jsx("button",{onClick:()=>z(null),className:"p-1",children:e.jsx(H,{className:"w-4 h-4"})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/10",children:[e.jsx("button",{onClick:()=>{i(""),a.forEach(s=>{URL.revokeObjectURL(s.preview),s.thumbnail?.preview&&URL.revokeObjectURL(s.thumbnail.preview)}),N([]),g("idle")},className:"text-white text-[15px] font-normal",children:"Cancel"}),e.jsx("span",{className:"text-white text-[15px] font-semibold",children:"New post"}),e.jsx("div",{className:"w-14"})," "]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-white/10 flex-shrink-0",children:t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:t.first_name||t.username||"User",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-white/60 text-base font-semibold",children:(t.first_name||t.username||"U")[0].toUpperCase()})}),(r.length>0||a.length>0)&&e.jsx("div",{className:"w-0.5 bg-white/10 flex-1 mt-2 min-h-[20px]"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("span",{className:"text-white text-[16px] font-semibold",children:t.first_name||t.username||"User"})}),e.jsx("textarea",{ref:R,value:r,onChange:s=>i(s.target.value.slice(0,500)),placeholder:"What's on your mind?",className:"w-full bg-transparent text-white text-[17px] placeholder-white/40 resize-none focus:outline-none min-h-[80px] leading-relaxed",rows:1}),a.length>0&&e.jsx("div",{className:"mt-3 -mx-1",children:e.jsx("div",{className:`flex gap-2 overflow-x-auto pb-2 ${a.length===1?"":"snap-x snap-mandatory"}`,children:a.map((s,c)=>e.jsxs("div",{className:`relative flex-shrink-0 rounded-xl overflow-hidden snap-center ${a.length===1?"w-full aspect-square":"w-[200px] h-[200px]"}`,children:[s.type==="image"?e.jsx("img",{src:s.preview,alt:"preview",className:"w-full h-full object-cover"}):e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("img",{src:s.thumbnail?.preview||s.preview,alt:"preview",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-10 h-10 rounded-full bg-black/60 backdrop-blur-sm flex items-center justify-center",children:e.jsx(me,{className:"w-4 h-4 text-white ml-0.5",fill:"white"})})})]}),e.jsx("button",{onClick:()=>Q(c),className:"absolute top-2 right-2 w-6 h-6 rounded-full bg-black/60 backdrop-blur-sm flex items-center justify-center",children:e.jsx(H,{className:"w-3.5 h-3.5 text-white"})})]},c))})}),e.jsxs("div",{className:"flex items-center gap-4 mt-3",children:[e.jsx("button",{onClick:()=>U.current?.click(),disabled:a.length>=4,className:"text-white/40 hover:text-white/60 transition-colors disabled:opacity-30",children:e.jsx(he,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>U.current?.click(),disabled:a.length>=4,className:"text-white/40 hover:text-white/60 transition-colors disabled:opacity-30",children:e.jsx(xe,{className:"w-5 h-5"})}),e.jsx("button",{className:"text-white/40 hover:text-white/60 transition-colors",children:e.jsx(ue,{className:"w-5 h-5"})}),r.length>400&&e.jsxs("span",{className:`text-xs ml-auto ${r.length>480?"text-orange-400":"text-white/30"}`,children:[r.length,"/500"]})]})]})]}),(r.length>0||a.length>0)&&e.jsxs("div",{className:"flex items-center gap-3 mt-4",children:[e.jsx("div",{className:"w-12 flex justify-center",children:e.jsx("div",{className:"w-7 h-7 rounded-full overflow-hidden bg-white/5 border border-white/10 flex items-center justify-center",children:t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:"",className:"w-full h-full object-cover opacity-60"}):e.jsx("div",{className:"text-white/30 text-[10px] font-semibold",children:(t.first_name||t.username||"U")[0].toUpperCase()})})}),e.jsx("span",{className:"text-white/30 text-[15px]",children:"Add to post..."})]})]})}),e.jsxs("div",{className:"border-t border-white/10 px-4 py-3 flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>k(!W),className:"flex items-center gap-1.5 text-white/50 text-[13px]",children:[ee(),e.jsx("span",{children:Z()}),e.jsx(oe,{className:"w-3.5 h-3.5"})]}),e.jsx("button",{onClick:Y,disabled:!B||C,className:`px-5 py-2 rounded-full text-[15px] font-semibold transition-all ${B&&!C?"bg-white text-black":"bg-white/10 text-white/30"}`,children:C?e.jsx(fe,{className:"w-4 h-4 animate-spin"}):"Post"})]}),e.jsx(V,{children:W&&e.jsxs(e.Fragment,{children:[e.jsx(T.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/60 z-40",onClick:()=>k(!1)}),e.jsxs(T.div,{initial:{opacity:0,y:100},animate:{opacity:1,y:0},exit:{opacity:0,y:100},className:"fixed bottom-0 left-0 right-0 bg-[#1c1c1e] rounded-t-2xl z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"w-10 h-1 bg-white/20 rounded-full mx-auto mb-4"}),e.jsx("h3",{className:"text-white text-lg font-semibold text-center mb-4",children:"Who can reply?"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>{w("public"),k(!1)},className:`w-full flex items-center gap-3 p-4 rounded-xl transition-colors ${m==="public"?"bg-white/10":"bg-transparent"}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/10 flex items-center justify-center",children:e.jsx(q,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"text-white font-medium",children:"Anyone"}),e.jsx("p",{className:"text-white/50 text-sm",children:"Anyone can reply to your post"})]}),m==="public"&&e.jsx("div",{className:"w-6 h-6 rounded-full bg-white flex items-center justify-center",children:e.jsx("div",{className:"w-2 h-2 rounded-full bg-black"})})]}),e.jsxs("button",{onClick:()=>{w("followers"),k(!1)},className:`w-full flex items-center gap-3 p-4 rounded-xl transition-colors ${m==="followers"?"bg-white/10":"bg-transparent"}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/10 flex items-center justify-center",children:e.jsx(G,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"text-white font-medium",children:"Followers"}),e.jsx("p",{className:"text-white/50 text-sm",children:"Only people who follow you"})]}),m==="followers"&&e.jsx("div",{className:"w-6 h-6 rounded-full bg-white flex items-center justify-center",children:e.jsx("div",{className:"w-2 h-2 rounded-full bg-black"})})]}),O&&e.jsxs("button",{onClick:()=>{w("subscribers"),k(!1)},className:`w-full flex items-center gap-3 p-4 rounded-xl transition-colors ${m==="subscribers"?"bg-white/10":"bg-transparent"}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/10 flex items-center justify-center",children:e.jsx(X,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"text-white font-medium",children:"Subscribers"}),e.jsx("p",{className:"text-white/50 text-sm",children:"Only your paid subscribers"})]}),m==="subscribers"&&e.jsx("div",{className:"w-6 h-6 rounded-full bg-white flex items-center justify-center",children:e.jsx("div",{className:"w-2 h-2 rounded-full bg-black"})})]})]})]}),e.jsx("div",{className:"h-8"})," "]})]})})]})}export{Ce as default};
