import{s as g,B as X,r as d,u as Z,l as Y,j as t,A as O,m as A,M as I,X as ee}from"./index-6hI245a3-1765489421505.js";import{L as $}from"./loader-circle-DzxBXhJs-1765489421505.js";import{H as P}from"./heart-DFM5RX4Q-1765489421505.js";async function te(s,o){const{data:i,error:u}=await g.from("comments").select("*, user:users!user_id(*)").eq("post_id",s).is("parent_id",null).order("created_at",{ascending:!1});if(u||!i)return[];let n=new Set;if(o){const{data:r}=await g.from("comment_likes").select("comment_id").eq("user_id",o);n=new Set(r?.map(l=>l.comment_id)||[])}return await Promise.all(i.map(async r=>{const{data:l}=await g.from("comments").select("*, user:users!user_id(*)").eq("parent_id",r.id).order("created_at",{ascending:!0});return{...r,liked:n.has(r.id),replies:(l||[]).map(m=>({...m,liked:n.has(m.id)}))}}))}async function se(s,o,i,u){const{data:n,error:a}=await g.from("comments").insert({post_id:s,user_id:o,content:i,parent_id:u||null}).select("*, user:users!user_id(*)").single();if(a)return console.error("Add comment error:",a),X.error("Failed to add comment"),null;await g.rpc("increment_comments",{p_post_id:s});const{data:r}=await g.from("posts").select("creator_id").eq("id",s).single();return r&&r.creator_id!==o&&await g.from("notifications").insert({user_id:r.creator_id,from_user_id:o,type:"comment",content:"commented on your post",reference_id:s.toString(),reference_type:"post"}),n}async function ne(s,o){const{error:i}=await g.from("comment_likes").insert({comment_id:s,user_id:o});return!i}async function re(s,o){const{error:i}=await g.from("comment_likes").delete().eq("comment_id",s).eq("user_id",o);return!i}function ie(s,o){const i=typeof o=="function"?{onInsert:o}:o,u=g.channel(`comments:${s}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"comments",filter:`post_id=eq.${s}`},async n=>{const{data:a}=await g.from("comments").select("*, user:users!user_id(*)").eq("id",n.new.id).single();a&&i.onInsert&&i.onInsert(a)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"comments",filter:`post_id=eq.${s}`},async n=>{const{data:a}=await g.from("comments").select("*, user:users!user_id(*)").eq("id",n.new.id).single();a&&i.onUpdate&&i.onUpdate(a)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"comments",filter:`post_id=eq.${s}`},n=>{i.onDelete&&i.onDelete(n.old.id)}).subscribe();return()=>{g.removeChannel(u)}}function ae(s,o){const[i,u]=d.useState(!1),[n,a]=d.useState(null);return{uploadComment:d.useCallback(async(l,m)=>{if(!s||!l.trim()||i)return null;u(!0),a(null);try{return await se(s,o,l.trim(),m)}catch(h){const b=h instanceof Error?h.message:"Failed to post comment";return console.error("Error uploading comment:",h),a(b),null}finally{u(!1)}},[s,o,i]),isLoading:i,error:n}}function oe(){const[s,o]=d.useState(!1),i=d.useCallback(async(n,a,r)=>{if(s)return;o(!0);const l=n.liked??!1,m=n.likes_count??0,h=!l,b=h?m+1:Math.max(0,m-1);r?.(h,b);try{l?await Z(a,n.id):await Y(a,n.id)}catch(w){console.error("Error updating post like:",w),r?.(l,m)}finally{o(!1)}},[s]),u=d.useCallback(async(n,a,r)=>{if(s)return;o(!0);const l=n.liked??!1,m=n.likes_count??0,h=!l,b=h?m+1:Math.max(0,m-1);r?.(h,b);try{l?await re(n.id,a):await ne(n.id,a)}catch(w){console.error("Error updating comment like:",w),r?.(l,m)}finally{o(!1)}},[s]);return{handlePostLike:i,handleCommentLike:u,loading:s}}function le(s=!0){const[o,i]=d.useState({visible:!1,height:0}),u=d.useRef(0),n=d.useRef(null),a=d.useCallback(()=>{if(!s)return;const r=window.visualViewport,l=window.Telegram?.WebApp;let m=0;if(r&&(m=Math.max(0,window.innerHeight-r.height-r.offsetTop)),l?.viewportHeight&&l?.viewportStableHeight){const h=Math.max(0,l.viewportStableHeight-l.viewportHeight);m=Math.max(m,h)}Math.abs(m-u.current)>20&&(u.current=m,i({visible:m>100,height:m}))},[s]);return d.useEffect(()=>{if(!s)return;const r=()=>{n.current!==null&&cancelAnimationFrame(n.current),n.current=requestAnimationFrame(a)},l=window.Telegram?.WebApp;return window.visualViewport?.addEventListener("resize",r),window.visualViewport?.addEventListener("scroll",r),l?.onEvent?.("viewportChanged",r),a(),()=>{window.visualViewport?.removeEventListener("resize",r),window.visualViewport?.removeEventListener("scroll",r),l?.offEvent?.("viewportChanged",r),n.current!==null&&cancelAnimationFrame(n.current)}},[s,a]),o}const ce=["â¤ï¸","ðŸ™Œ","ðŸ”¥","ðŸ‘","ðŸ˜¢","ðŸ˜","ðŸ˜®","ðŸ˜‚"],D=4;function fe({isOpen:s,onClose:o,postId:i,user:u}){const[n,a]=d.useState([]),[r,l]=d.useState(""),[m,h]=d.useState(!0),[b,w]=d.useState(null),[F,j]=d.useState({}),[R,L]=d.useState(!1),y=d.useRef(null),S=d.useRef(null),N=d.useRef(null),C=le(s),{uploadComment:K,isLoading:E}=ae(i,u.telegram_id),{handleCommentLike:V}=oe();d.useEffect(()=>{if(s&&i){z();const e=ie(i,c=>{c.user_id!==u.telegram_id&&(c.parent_id?a(f=>f.map(x=>x.id===c.parent_id?{...x,replies:[...x.replies||[],c]}:x)):a(f=>[c,...f]))});return()=>e()}else a([]),l(""),w(null),j({})},[s,i]);const z=async()=>{if(!i)return;h(!0);const e=await te(i,u.telegram_id);a(e),h(!1)},U=e=>{l(e.target.value),e.target.style.height="auto",e.target.style.height=`${Math.min(e.target.scrollHeight,80)}px`};d.useEffect(()=>{C.visible&&N.current&&N.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[C.visible]);const B=e=>{l(c=>c+e),y.current?.focus()},_=d.useRef(null),H=async()=>{if(!r.trim()||E||!i)return;const e=r.trim(),c=b?.id,f=b;_.current&&(_.current.style.transition="none",_.current.style.paddingBottom="calc(env(safe-area-inset-bottom, 0px) + 12px)"),L(!0),y.current?.blur(),l(""),w(null),y.current&&(y.current.style.height="auto"),setTimeout(()=>{L(!1),_.current&&(_.current.style.transition="",_.current.style.paddingBottom="")},600);const x=await K(e,c);x&&(f?a(p=>p.map(v=>{if(v.id===f.id){const k=[...v.replies||[],x];return j(G=>({...G,[v.id]:k.length})),{...v,replies:k}}return v})):(a(p=>[x,...p]),requestAnimationFrame(()=>{S.current?.scrollTo({top:0,behavior:"smooth"})})))},M=e=>{V(e,u.telegram_id,(c,f)=>{const x=p=>p.id===e.id?{...p,liked:c,likes_count:f}:p.replies?{...p,replies:p.replies.map(x)}:p;a(p=>p.map(x))})},T=e=>{const c=Date.now()-new Date(e).getTime(),f=Math.floor(c/6e4);if(f<1)return"now";if(f<60)return`${f}m`;const x=Math.floor(f/60);return x<24?`${x}h`:`${Math.floor(x/24)}d`},q=(e,c)=>F[e]??Math.min(D,c),W=(e,c)=>{const f=q(e,c);j(x=>({...x,[e]:Math.min(f+D,c)}))},J=(e,c)=>t.jsxs("div",{className:"flex gap-1.5 mt-2",children:[t.jsx("img",{src:e.user?.avatar_url||`https://i.pravatar.cc/150?u=${e.user_id}`,alt:"",className:"w-5 h-5 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{children:[t.jsx("span",{className:"font-semibold text-[12px] text-white mr-1",children:e.user?.username||e.user?.first_name}),t.jsx("span",{className:"text-[12px] text-white/85 leading-snug whitespace-pre-wrap break-words",children:e.content})]}),t.jsxs("div",{className:"flex items-center gap-2.5 mt-0.5",children:[t.jsx("span",{className:"text-[10px] text-gray-500",children:T(e.created_at)}),(e.likes_count||0)>0&&t.jsxs("span",{className:"text-[10px] text-gray-500 font-medium",children:[e.likes_count," ",e.likes_count===1?"like":"likes"]}),t.jsx("button",{className:"text-[10px] font-semibold text-gray-500 active:text-gray-300",onClick:()=>{w(c),y.current?.focus()},children:"Reply"})]})]}),t.jsx("button",{onClick:()=>M(e),className:"pt-0.5 active:scale-90 transition-transform",children:t.jsx(P,{className:`w-2 h-2 ${e.liked?"fill-red-500 text-red-500":"text-gray-500"}`})})]},e.id),Q=e=>{const c=e.replies||[],f=c.length,x=q(e.id,f),p=c.slice(0,x),v=f-x;return t.jsxs("div",{className:"mt-3 first:mt-0",children:[t.jsxs("div",{className:"flex gap-2.5",children:[t.jsx("img",{src:e.user?.avatar_url||`https://i.pravatar.cc/150?u=${e.user_id}`,alt:"",className:"w-8 h-8 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"flex items-start gap-2",children:t.jsxs("div",{className:"flex-1",children:[t.jsx("span",{className:"font-semibold text-[13px] text-white mr-1.5",children:e.user?.username||e.user?.first_name}),t.jsx("span",{className:"text-[13px] text-white/90 leading-snug whitespace-pre-wrap break-words",children:e.content})]})}),t.jsxs("div",{className:"flex items-center gap-3 mt-1",children:[t.jsx("span",{className:"text-[11px] text-gray-500",children:T(e.created_at)}),(e.likes_count||0)>0&&t.jsxs("span",{className:"text-[11px] text-gray-500 font-semibold",children:[e.likes_count," ",e.likes_count===1?"like":"likes"]}),t.jsx("button",{className:"text-[11px] font-semibold text-gray-500 active:text-gray-300",onClick:()=>{w(e),y.current?.focus()},children:"Reply"})]})]}),t.jsx("button",{onClick:()=>M(e),className:"pt-1 active:scale-90 transition-transform",children:t.jsx(P,{className:`w-2.5 h-2.5 ${e.liked?"fill-red-500 text-red-500":"text-gray-500"}`})})]}),f>0&&t.jsxs("div",{className:"ml-10 mt-1.5",children:[p.map(k=>J(k,e)),v>0&&t.jsxs("button",{onClick:()=>W(e.id,f),className:"flex items-center gap-2 mt-2 text-[11px] font-semibold text-gray-500 active:text-gray-300",children:[t.jsx("div",{className:"w-5 h-px bg-gray-600"}),"View ",v," more ",v===1?"reply":"replies"]})]})]},e.id)};return t.jsx(O,{mode:"sync",children:s&&t.jsxs(t.Fragment,{children:[t.jsx(A.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-black/70 backdrop-blur-[2px] z-[9998]",onClick:()=>{y.current?.blur(),o()}}),t.jsxs(A.div,{ref:_,initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"tween",duration:.18,ease:[.32,.72,0,1]},className:"fixed inset-x-0 bottom-0 z-[9999] bg-[#0c0c0c] rounded-t-[16px] flex flex-col overflow-hidden will-change-transform shadow-[0_-14px_60px_rgba(0,0,0,0.45)] border border-white/5 border-b-0",style:{height:"calc(var(--app-height) - 96px)",maxHeight:"calc(var(--app-height) - 72px)",paddingBottom:R?"calc(env(safe-area-inset-bottom, 0px) + 12px)":C.visible?"calc(var(--keyboard-height) + env(safe-area-inset-bottom, 0px) + 10px)":"calc(env(safe-area-inset-bottom, 0px) + 12px)",transition:R?"none":"padding-bottom 0.08s linear",transform:"translateZ(0)"},children:[t.jsx("div",{className:"flex justify-center pt-3 pb-2 cursor-pointer flex-shrink-0",onClick:o,children:t.jsx("div",{className:"w-9 h-1 bg-[#555] rounded-full"})}),t.jsx("div",{className:"text-center pb-3 border-b border-[#1f1f1f] flex-shrink-0",children:t.jsx("h3",{className:"font-semibold text-white text-base tracking-tight",children:"Comments"})}),t.jsx("div",{ref:S,className:"flex-1 overflow-y-auto px-4 overscroll-contain",style:{minHeight:0,background:"linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0))"},children:m?t.jsx("div",{className:"flex justify-center py-12",children:t.jsx($,{className:"w-6 h-6 animate-spin text-gray-400"})}):n.length===0?t.jsxs("div",{className:"text-center py-16",children:[t.jsx("div",{className:"w-20 h-20 bg-[#363636] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx(I,{className:"w-10 h-10 text-gray-500"})}),t.jsx("h3",{className:"font-semibold text-white text-xl mb-2",children:"No comments yet"}),t.jsx("p",{className:"text-sm text-gray-500",children:"Start the conversation."})]}):t.jsx("div",{className:"py-4",children:n.map(e=>Q(e))})}),t.jsxs("div",{ref:N,className:"border-t border-[#1f1f1f] bg-[#0c0c0c] flex-shrink-0 pb-[env(safe-area-inset-bottom)]",children:[t.jsx("div",{className:"flex justify-around px-6 py-3",children:ce.map(e=>t.jsx("button",{onClick:()=>B(e),className:"text-[22px] active:scale-90 transition-transform",children:e},e))}),b&&t.jsxs("div",{className:"flex justify-between items-center px-4 py-2 bg-[#363636] mx-4 rounded-lg text-xs text-gray-400 mb-2",children:[t.jsxs("span",{children:["Replying to ",t.jsx("span",{className:"font-semibold text-white",children:b.user?.username||"User"})]}),t.jsx("button",{onClick:()=>w(null),className:"p-1",children:t.jsx(ee,{className:"w-3.5 h-3.5"})})]}),t.jsxs("div",{className:"flex items-center gap-3 px-4 pb-3",children:[t.jsx("img",{src:u.avatar_url||`https://i.pravatar.cc/150?u=${u.telegram_id}`,alt:"",className:"w-9 h-9 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 flex items-center bg-[#151515] border border-[#2e2e2e] rounded-full px-4 py-2 focus-within:border-[#444] transition-colors",children:[t.jsx("textarea",{ref:y,value:r,onChange:U,placeholder:b?"Reply...":"Add a comment...",rows:1,enterKeyHint:"send",className:"flex-1 bg-transparent text-white text-[15px] placeholder-[#888] focus:outline-none resize-none max-h-20",style:{minHeight:"22px"},onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),H())}}),r.trim()&&t.jsx("button",{onClick:H,disabled:E,className:"text-[#0095f6] font-semibold text-[15px] ml-2 disabled:opacity-50",children:E?t.jsx($,{className:"w-5 h-5 animate-spin"}):"Post"})]})]})]})]})]})})}export{fe as C};
