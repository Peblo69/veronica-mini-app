const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BdHMCFSL-1765578218326.js","assets/index-bwklTcX8-1765578218326.css"])))=>i.map(i=>d[i]);
import{c as le,d as g,t as R,r as m,u as oe,l as ce,j as t,A as de,m as B,M as me,_ as ue}from"./index-BdHMCFSL-1765578218326.js";import{L as O}from"./loader-circle-Dj2GLsl--1765578218326.js";import{X as xe}from"./x-CzlnUtKG-1765578218326.js";import{H as J}from"./heart-_usH0kki-1765578218326.js";import{T as Q}from"./trash-2-xAmE_7bY-1765578218326.js";import{F as G}from"./flag-C5own2ZA-1765578218326.js";const fe=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]],X=le("ellipsis",fe);async function pe(n,a){const{data:r,error:p}=await g.from("comments").select("*, user:users!user_id(*)").eq("post_id",n).is("parent_id",null).order("created_at",{ascending:!1});if(p||!r)return[];let s=new Set;if(a){const{data:i}=await g.from("comment_likes").select("comment_id").eq("user_id",a);s=new Set(i?.map(l=>l.comment_id)||[])}return await Promise.all(r.map(async i=>{const{data:l}=await g.from("comments").select("*, user:users!user_id(*)").eq("parent_id",i.id).order("created_at",{ascending:!0});return{...i,liked:s.has(i.id),replies:(l||[]).map(c=>({...c,liked:s.has(c.id)}))}}))}async function he(n,a,r,p){const{data:s,error:o}=await g.from("comments").insert({post_id:n,user_id:a,content:r,parent_id:p||null}).select("*, user:users!user_id(*)").single();if(o)return console.error("Add comment error:",o),R.error("Failed to add comment"),null;await g.rpc("increment_comments",{p_post_id:n});const{data:i}=await g.from("posts").select("creator_id").eq("id",n).single();return i&&i.creator_id!==a&&await g.from("notifications").insert({user_id:i.creator_id,from_user_id:a,type:"comment",content:"commented on your post",reference_id:n.toString(),reference_type:"post"}),s}async function ge(n,a,r){await g.from("comments").delete().eq("parent_id",n);const{error:p}=await g.from("comments").delete().eq("id",n).eq("user_id",a);return p||await g.rpc("decrement_comments",{p_post_id:r}),!p}async function be(n,a){const{error:r}=await g.from("comment_likes").insert({comment_id:n,user_id:a});return!r}async function we(n,a){const{error:r}=await g.from("comment_likes").delete().eq("comment_id",n).eq("user_id",a);return!r}function ve(n,a){const r=typeof a=="function"?{onInsert:a}:a,p=g.channel(`comments:${n}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"comments",filter:`post_id=eq.${n}`},async s=>{const{data:o}=await g.from("comments").select("*, user:users!user_id(*)").eq("id",s.new.id).single();o&&r.onInsert&&r.onInsert(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"comments",filter:`post_id=eq.${n}`},async s=>{const{data:o}=await g.from("comments").select("*, user:users!user_id(*)").eq("id",s.new.id).single();o&&r.onUpdate&&r.onUpdate(o)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"comments",filter:`post_id=eq.${n}`},s=>{r.onDelete&&r.onDelete(s.old.id)}).subscribe();return()=>{g.removeChannel(p)}}function _e(n,a){const[r,p]=m.useState(!1),[s,o]=m.useState(null);return{uploadComment:m.useCallback(async(l,c)=>{if(!n||!l.trim()||r)return null;p(!0),o(null);try{return await he(n,a,l.trim(),c)}catch(b){const v=b instanceof Error?b.message:"Failed to post comment";return console.error("Error uploading comment:",b),o(v),null}finally{p(!1)}},[n,a,r]),isLoading:r,error:s}}function je(){const[n,a]=m.useState(!1),r=m.useCallback(async(s,o,i)=>{if(n)return;a(!0);const l=s.liked??!1,c=s.likes_count??0,b=!l,v=b?c+1:Math.max(0,c-1);i?.(b,v);try{l?await oe(o,s.id):await ce(o,s.id)}catch(w){console.error("Error updating post like:",w),i?.(l,c)}finally{a(!1)}},[n]),p=m.useCallback(async(s,o,i)=>{if(n)return;a(!0);const l=s.liked??!1,c=s.likes_count??0,b=!l,v=b?c+1:Math.max(0,c-1);i?.(b,v);try{l?await we(s.id,o):await be(s.id,o)}catch(w){console.error("Error updating comment like:",w),i?.(l,c)}finally{a(!1)}},[n]);return{handlePostLike:r,handleCommentLike:p,loading:n}}function ye(n=!0){const[a,r]=m.useState({visible:!1,height:0}),p=m.useRef(0),s=m.useRef(null),o=m.useCallback(()=>{if(!n)return;const i=window.visualViewport,l=window.Telegram?.WebApp;let c=0;if(i&&(c=Math.max(0,window.innerHeight-i.height-i.offsetTop)),l?.viewportHeight&&l?.viewportStableHeight){const b=Math.max(0,l.viewportStableHeight-l.viewportHeight);c=Math.max(c,b)}Math.abs(c-p.current)>20&&(p.current=c,r({visible:c>100,height:c}))},[n]);return m.useEffect(()=>{if(!n)return;const i=()=>{s.current!==null&&cancelAnimationFrame(s.current),s.current=requestAnimationFrame(o)},l=window.Telegram?.WebApp;return window.visualViewport?.addEventListener("resize",i),window.visualViewport?.addEventListener("scroll",i),l?.onEvent?.("viewportChanged",i),o(),()=>{window.visualViewport?.removeEventListener("resize",i),window.visualViewport?.removeEventListener("scroll",i),l?.offEvent?.("viewportChanged",i),s.current!==null&&cancelAnimationFrame(s.current)}},[n,o]),a}const ke=["â¤ï¸","ðŸ™Œ","ðŸ”¥","ðŸ‘","ðŸ˜¢","ðŸ˜","ðŸ˜®","ðŸ˜‚"],Z=4;function qe({isOpen:n,onClose:a,postId:r,postCreatorId:p,user:s}){const[o,i]=m.useState([]),[l,c]=m.useState(""),[b,v]=m.useState(!0),[w,N]=m.useState(null),[Y,L]=m.useState({}),[D,H]=m.useState(!1),[C,y]=m.useState(null),[E,F]=m.useState(null),_=m.useRef(null),A=m.useRef(null),S=m.useRef(null),q=ye(n),{uploadComment:I,isLoading:T}=_e(r,s.telegram_id),{handleCommentLike:ee}=je();m.useEffect(()=>{if(n&&r){te();const e=ve(r,d=>{d.user_id!==s.telegram_id&&(d.parent_id?i(x=>x.map(u=>u.id===d.parent_id?{...u,replies:[...u.replies||[],d]}:u)):i(x=>[d,...x]))});return()=>e()}else i([]),c(""),N(null),L({}),y(null)},[n,r]);const te=async()=>{if(!r)return;v(!0);const e=await pe(r,s.telegram_id);i(e),v(!1)},se=e=>{c(e.target.value),e.target.style.height="auto",e.target.style.height=`${Math.min(e.target.scrollHeight,80)}px`};m.useEffect(()=>{q.visible&&S.current&&S.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[q.visible]);const ne=e=>{c(d=>d+e),_.current?.focus()},k=m.useRef(null),P=async()=>{if(!l.trim()||T||!r)return;const e=l.trim(),d=w?.id,x=w;k.current&&(k.current.style.transition="none",k.current.style.paddingBottom="calc(env(safe-area-inset-bottom, 0px) + 12px)"),H(!0),_.current?.blur(),c(""),N(null),_.current&&(_.current.style.height="auto"),setTimeout(()=>{H(!1),k.current&&(k.current.style.transition="",k.current.style.paddingBottom="")},600);const u=await I(e,d);u&&(x?i(f=>f.map(h=>{if(h.id===x.id){const j=[...h.replies||[],u];return L(M=>({...M,[h.id]:j.length})),{...h,replies:j}}return h})):(i(f=>[u,...f]),requestAnimationFrame(()=>{A.current?.scrollTo({top:0,behavior:"smooth"})})))},$=e=>{ee(e,s.telegram_id,(d,x)=>{const u=f=>f.id===e.id?{...f,liked:d,likes_count:x}:f.replies?{...f,replies:f.replies.map(u)}:f;i(f=>f.map(u))})},z=e=>e.user_id===s.telegram_id||p===s.telegram_id,V=async e=>{if(!r)return;F(e.id),y(null);const d=p===s.telegram_id,x=e.user_id===s.telegram_id;let u=!1;if(x)u=await ge(e.id,s.telegram_id,r);else if(d){const{supabase:f}=await ue(async()=>{const{supabase:j}=await import("./index-BdHMCFSL-1765578218326.js").then(M=>M.aE);return{supabase:j}},__vite__mapDeps([0,1]));await f.from("comments").delete().eq("parent_id",e.id);const{error:h}=await f.from("comments").delete().eq("id",e.id);h||(await f.rpc("decrement_comments",{p_post_id:r}),u=!0)}u?(e.parent_id?i(f=>f.map(h=>h.id===e.parent_id?{...h,replies:(h.replies||[]).filter(j=>j.id!==e.id)}:h)):i(f=>f.filter(h=>h.id!==e.id)),R.success("Comment deleted")):R.error("Failed to delete comment"),F(null)},K=e=>{y(null),R.success("Comment reported")},U=e=>{const d=Date.now()-new Date(e).getTime(),x=Math.floor(d/6e4);if(x<1)return"now";if(x<60)return`${x}m`;const u=Math.floor(x/60);return u<24?`${u}h`:`${Math.floor(u/24)}d`},W=(e,d)=>Y[e]??Math.min(Z,d),ie=(e,d)=>{const x=W(e,d);L(u=>({...u,[e]:Math.min(x+Z,d)}))},re=(e,d)=>t.jsxs("div",{className:"flex gap-1.5 mt-2 relative",children:[t.jsx("img",{src:e.user?.avatar_url||`https://i.pravatar.cc/150?u=${e.user_id}`,alt:"",className:"w-5 h-5 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{children:[t.jsx("span",{className:"font-semibold text-[12px] text-white mr-1",children:e.user?.username||e.user?.first_name}),t.jsx("span",{className:"text-[12px] text-white/85 leading-snug whitespace-pre-wrap break-words",children:e.content})]}),t.jsxs("div",{className:"flex items-center gap-2.5 mt-0.5",children:[t.jsx("span",{className:"text-[10px] text-gray-500",children:U(e.created_at)}),(e.likes_count||0)>0&&t.jsxs("span",{className:"text-[10px] text-gray-500 font-medium",children:[e.likes_count," ",e.likes_count===1?"like":"likes"]}),t.jsx("button",{className:"text-[10px] font-semibold text-gray-500 active:text-gray-300",onClick:()=>{N(d),_.current?.focus()},children:"Reply"})]})]}),t.jsxs("div",{className:"flex items-start gap-1 pt-0.5",children:[t.jsx("button",{onClick:()=>$(e),className:"active:scale-90 transition-transform",children:t.jsx(J,{className:`w-2 h-2 ${e.liked?"fill-red-500 text-red-500":"text-gray-500"}`})}),t.jsx("button",{onClick:()=>y(C===e.id?null:e.id),className:"active:scale-90 transition-transform p-0.5",children:t.jsx(X,{className:"w-3 h-3 text-gray-500"})})]}),C===e.id&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>y(null)}),t.jsxs("div",{className:"absolute right-0 top-6 bg-[#262626] rounded-lg shadow-xl z-20 overflow-hidden min-w-[140px] border border-white/10",children:[z(e)&&t.jsxs("button",{onClick:()=>V(e),disabled:E===e.id,className:"w-full flex items-center gap-2 px-4 py-2.5 text-red-500 hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(Q,{className:"w-4 h-4"}),E===e.id?"Deleting...":"Delete"]}),t.jsxs("button",{onClick:()=>K(),className:"w-full flex items-center gap-2 px-4 py-2.5 text-white hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(G,{className:"w-4 h-4"}),"Report"]})]})]})]},e.id),ae=e=>{const d=e.replies||[],x=d.length,u=W(e.id,x),f=d.slice(0,u),h=x-u;return t.jsxs("div",{className:"mt-3 first:mt-0 relative",children:[t.jsxs("div",{className:"flex gap-2.5",children:[t.jsx("img",{src:e.user?.avatar_url||`https://i.pravatar.cc/150?u=${e.user_id}`,alt:"",className:"w-8 h-8 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"flex items-start gap-2",children:t.jsxs("div",{className:"flex-1",children:[t.jsx("span",{className:"font-semibold text-[13px] text-white mr-1.5",children:e.user?.username||e.user?.first_name}),t.jsx("span",{className:"text-[13px] text-white/90 leading-snug whitespace-pre-wrap break-words",children:e.content})]})}),t.jsxs("div",{className:"flex items-center gap-3 mt-1",children:[t.jsx("span",{className:"text-[11px] text-gray-500",children:U(e.created_at)}),(e.likes_count||0)>0&&t.jsxs("span",{className:"text-[11px] text-gray-500 font-semibold",children:[e.likes_count," ",e.likes_count===1?"like":"likes"]}),t.jsx("button",{className:"text-[11px] font-semibold text-gray-500 active:text-gray-300",onClick:()=>{N(e),_.current?.focus()},children:"Reply"})]})]}),t.jsxs("div",{className:"flex items-start gap-1 pt-1",children:[t.jsx("button",{onClick:()=>$(e),className:"active:scale-90 transition-transform",children:t.jsx(J,{className:`w-2.5 h-2.5 ${e.liked?"fill-red-500 text-red-500":"text-gray-500"}`})}),t.jsx("button",{onClick:()=>y(C===e.id?null:e.id),className:"active:scale-90 transition-transform p-0.5",children:t.jsx(X,{className:"w-3.5 h-3.5 text-gray-500"})})]})]}),C===e.id&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>y(null)}),t.jsxs("div",{className:"absolute right-0 top-8 bg-[#262626] rounded-lg shadow-xl z-20 overflow-hidden min-w-[140px] border border-white/10",children:[z(e)&&t.jsxs("button",{onClick:()=>V(e),disabled:E===e.id,className:"w-full flex items-center gap-2 px-4 py-2.5 text-red-500 hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(Q,{className:"w-4 h-4"}),E===e.id?"Deleting...":"Delete"]}),t.jsxs("button",{onClick:()=>K(),className:"w-full flex items-center gap-2 px-4 py-2.5 text-white hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(G,{className:"w-4 h-4"}),"Report"]})]})]}),x>0&&t.jsxs("div",{className:"ml-10 mt-1.5",children:[f.map(j=>re(j,e)),h>0&&t.jsxs("button",{onClick:()=>ie(e.id,x),className:"flex items-center gap-2 mt-2 text-[11px] font-semibold text-gray-500 active:text-gray-300",children:[t.jsx("div",{className:"w-5 h-px bg-gray-600"}),"View ",h," more ",h===1?"reply":"replies"]})]})]},e.id)};return t.jsx(de,{mode:"sync",children:n&&t.jsxs(t.Fragment,{children:[t.jsx(B.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-black/70 backdrop-blur-[2px] z-[9998]",onClick:()=>{_.current?.blur(),a()}}),t.jsxs(B.div,{ref:k,initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"tween",duration:.18,ease:[.32,.72,0,1]},className:"fixed inset-x-0 bottom-0 z-[9999] bg-[#0c0c0c] rounded-t-[16px] flex flex-col overflow-hidden will-change-transform shadow-[0_-14px_60px_rgba(0,0,0,0.45)] border border-white/5 border-b-0",style:{height:"calc(var(--app-height) - 96px)",maxHeight:"calc(var(--app-height) - 72px)",paddingBottom:D?"calc(env(safe-area-inset-bottom, 0px) + 12px)":q.visible?"calc(var(--keyboard-height) + env(safe-area-inset-bottom, 0px) + 10px)":"calc(env(safe-area-inset-bottom, 0px) + 12px)",transition:D?"none":"padding-bottom 0.08s linear",transform:"translateZ(0)"},children:[t.jsx("div",{className:"flex justify-center pt-3 pb-2 cursor-pointer flex-shrink-0",onClick:a,children:t.jsx("div",{className:"w-9 h-1 bg-[#555] rounded-full"})}),t.jsx("div",{className:"text-center pb-3 border-b border-[#1f1f1f] flex-shrink-0",children:t.jsx("h3",{className:"font-semibold text-white text-base tracking-tight",children:"Comments"})}),t.jsx("div",{ref:A,className:"flex-1 overflow-y-auto px-4 overscroll-contain",style:{minHeight:0,background:"linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0))"},children:b?t.jsx("div",{className:"flex justify-center py-12",children:t.jsx(O,{className:"w-6 h-6 animate-spin text-gray-400"})}):o.length===0?t.jsxs("div",{className:"text-center py-16",children:[t.jsx("div",{className:"w-20 h-20 bg-[#363636] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx(me,{className:"w-10 h-10 text-gray-500"})}),t.jsx("h3",{className:"font-semibold text-white text-xl mb-2",children:"No comments yet"}),t.jsx("p",{className:"text-sm text-gray-500",children:"Start the conversation."})]}):t.jsx("div",{className:"py-4",children:o.map(e=>ae(e))})}),t.jsxs("div",{ref:S,className:"border-t border-[#1f1f1f] bg-[#0c0c0c] flex-shrink-0 pb-[env(safe-area-inset-bottom)]",children:[t.jsx("div",{className:"flex justify-around px-6 py-3",children:ke.map(e=>t.jsx("button",{onClick:()=>ne(e),className:"text-[22px] active:scale-90 transition-transform",children:e},e))}),w&&t.jsxs("div",{className:"flex justify-between items-center px-4 py-2 bg-[#363636] mx-4 rounded-lg text-xs text-gray-400 mb-2",children:[t.jsxs("span",{children:["Replying to ",t.jsx("span",{className:"font-semibold text-white",children:w.user?.username||"User"})]}),t.jsx("button",{onClick:()=>N(null),className:"p-1",children:t.jsx(xe,{className:"w-3.5 h-3.5"})})]}),t.jsxs("div",{className:"flex items-center gap-3 px-4 pb-3",children:[t.jsx("img",{src:s.avatar_url||`https://i.pravatar.cc/150?u=${s.telegram_id}`,alt:"",className:"w-9 h-9 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 flex items-center bg-[#151515] border border-[#2e2e2e] rounded-full px-4 py-2 focus-within:border-[#444] transition-colors",children:[t.jsx("textarea",{ref:_,value:l,onChange:se,placeholder:w?"Reply...":"Add a comment...",rows:1,enterKeyHint:"send",className:"flex-1 bg-transparent text-white text-[15px] placeholder-[#888] focus:outline-none resize-none max-h-20",style:{minHeight:"22px"},onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),P())}}),l.trim()&&t.jsx("button",{onClick:P,disabled:T,className:"text-[#0095f6] font-semibold text-[15px] ml-2 disabled:opacity-50",children:T?t.jsx(O,{className:"w-5 h-5 animate-spin"}):"Post"})]})]})]})]})]})})}export{qe as C,X as E};
