import{c as G,j as e,s as p,z as Z,r as h,u as Y,l as O,A as I,m as P,M as ee,X as te}from"./index-JEutaQNo-1765404370741.js";import{L as A}from"./loader-circle-CIa1g7l7-1765404370741.js";import{H as T}from"./heart-CF2ED6-h-1765404370741.js";const se=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]],ve=G("volume-x",se);function fe({className:s="w-6 h-6",filled:n=!1}){return e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:s,children:n?e.jsx("path",{d:"M9 2H5v2H3v2H1v6h2v2h2v2h2v2h2v2h2v2h2v-2h2v-2h2v-2h2v-2h2v-2h2V6h-2V4h-2V2h-4v2h-2v2h-2V4H9V2z",fill:"currentColor"}):e.jsx("path",{d:"M9 2H5v2H3v2H1v6h2v2h2v2h2v2h2v2h2v2h2v-2h2v-2h2v-2h2v-2h2v-2h2V6h-2V4h-2V2h-4v2h-2v2h-2V4H9V2zm0 2v2h2v2h2V6h2V4h4v2h2v6h-2v2h-2v2h-2v2h-2v2h-2v-2H9v-2H7v-2H5v-2H3V6h2V4h4z",fill:"currentColor"})})}function pe({className:s="w-6 h-6"}){return e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:s,children:e.jsx("path",{d:"M22 2H2v14h2V4h16v12h-8v2h-2v2H8v-4H2v2h4v4h4v-2h2v-2h10V2z",fill:"currentColor"})})}function ge({className:s="w-6 h-6"}){return e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:s,children:e.jsx("path",{d:"M14 5h-2v4H6v2H4v6h2v-2h6v4h2v-2h2v-2h2v-2h2v-2h-2V9h-2V7h-2V5z",fill:"currentColor"})})}function we({className:s="w-6 h-6",filled:n=!1}){return e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:s,children:n?e.jsx("path",{d:"M6 2h12v20h-2v-2h-2v-2h-4v2H8v2H6V2z",fill:"currentColor"}):e.jsx("path",{d:"M18 2H6v2h12v16h-2v-2h-2v-2h-4v2H8v2H6V2H4v20h4v-2h2v-2h4v2h2v2h4V2h-2z",fill:"currentColor"})})}function be({className:s="w-6 h-6",filled:n=!1}){return e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:s,children:n?e.jsx("path",{d:"M6 2h12v2H6V2zM4 6V4h2v2H4zm0 12V6H2v12h2zm2 2v-2H4v2h2zm12 0v2H6v-2h12zm2-2v2h-2v-2h2zm0-12h2v12h-2V6zm0 0V4h-2v2h2zm-7-1h2v4h4v2h-4v4h-2v-4H7v-2h4V5z",fill:"currentColor"}):e.jsx("path",{d:"M6 2h12v2H6V2zM4 6V4h2v2H4zm0 12V6H2v12h2zm2 2v-2H4v2h2zm12 0v2H6v-2h12zm2-2v2h-2v-2h2zm0-12h2v12h-2V6zm0 0V4h-2v2h2zm-9-1h2v2h3v2h-6v2h6v6h-3v2h-2v-2H8v-2h6v-2H8V7h3V5z",fill:"currentColor"})})}async function ne(s,n){const{data:a,error:m}=await p.from("comments").select("*, user:users!user_id(*)").eq("post_id",s).is("parent_id",null).order("created_at",{ascending:!1});if(m||!a)return[];let r=new Set;if(n){const{data:i}=await p.from("comment_likes").select("comment_id").eq("user_id",n);r=new Set(i?.map(o=>o.comment_id)||[])}return await Promise.all(a.map(async i=>{const{data:o}=await p.from("comments").select("*, user:users!user_id(*)").eq("parent_id",i.id).order("created_at",{ascending:!0});return{...i,liked:r.has(i.id),replies:(o||[]).map(d=>({...d,liked:r.has(d.id)}))}}))}async function re(s,n,a,m){const{data:r,error:l}=await p.from("comments").insert({post_id:s,user_id:n,content:a,parent_id:m||null}).select("*, user:users!user_id(*)").single();if(l)return console.error("Add comment error:",l),Z.error("Failed to add comment"),null;await p.rpc("increment_comments",{p_post_id:s});const{data:i}=await p.from("posts").select("creator_id").eq("id",s).single();return i&&i.creator_id!==n&&await p.from("notifications").insert({user_id:i.creator_id,from_user_id:n,type:"comment",content:"commented on your post",reference_id:s.toString(),reference_type:"post"}),r}async function ie(s,n){const{error:a}=await p.from("comment_likes").insert({comment_id:s,user_id:n});return!a}async function ae(s,n){const{error:a}=await p.from("comment_likes").delete().eq("comment_id",s).eq("user_id",n);return!a}function le(s,n){const a=typeof n=="function"?{onInsert:n}:n,m=p.channel(`comments:${s}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"comments",filter:`post_id=eq.${s}`},async r=>{const{data:l}=await p.from("comments").select("*, user:users!user_id(*)").eq("id",r.new.id).single();l&&a.onInsert&&a.onInsert(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"comments",filter:`post_id=eq.${s}`},async r=>{const{data:l}=await p.from("comments").select("*, user:users!user_id(*)").eq("id",r.new.id).single();l&&a.onUpdate&&a.onUpdate(l)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"comments",filter:`post_id=eq.${s}`},r=>{a.onDelete&&a.onDelete(r.old.id)}).subscribe();return()=>{p.removeChannel(m)}}function oe(s,n){const[a,m]=h.useState(!1),[r,l]=h.useState(null);return{uploadComment:h.useCallback(async(o,d)=>{if(!s||!o.trim()||a)return null;m(!0),l(null);try{return await re(s,n,o.trim(),d)}catch(v){const g=v instanceof Error?v.message:"Failed to post comment";return console.error("Error uploading comment:",v),l(g),null}finally{m(!1)}},[s,n,a]),isLoading:a,error:r}}function ce(){const[s,n]=h.useState(!1),a=h.useCallback(async(r,l,i)=>{if(s)return;n(!0);const o=r.liked??!1,d=r.likes_count??0,v=!o,g=v?d+1:Math.max(0,d-1);i?.(v,g);try{o?await Y(l,r.id):await O(l,r.id)}catch(w){console.error("Error updating post like:",w),i?.(o,d)}finally{n(!1)}},[s]),m=h.useCallback(async(r,l,i)=>{if(s)return;n(!0);const o=r.liked??!1,d=r.likes_count??0,v=!o,g=v?d+1:Math.max(0,d-1);i?.(v,g);try{o?await ae(r.id,l):await ie(r.id,l)}catch(w){console.error("Error updating comment like:",w),i?.(o,d)}finally{n(!1)}},[s]);return{handlePostLike:a,handleCommentLike:m,loading:s}}function he(s=!0){const[n,a]=h.useState({visible:!1,height:0}),m=h.useRef(0),r=h.useRef(null),l=h.useCallback(()=>{if(!s)return;const i=window.visualViewport,o=window.Telegram?.WebApp;let d=0;if(i&&(d=Math.max(0,window.innerHeight-i.height-i.offsetTop)),o?.viewportHeight&&o?.viewportStableHeight){const v=Math.max(0,o.viewportStableHeight-o.viewportHeight);d=Math.max(d,v)}Math.abs(d-m.current)>20&&(m.current=d,a({visible:d>100,height:d}))},[s]);return h.useEffect(()=>{if(!s)return;const i=()=>{r.current!==null&&cancelAnimationFrame(r.current),r.current=requestAnimationFrame(l)},o=window.Telegram?.WebApp;return window.visualViewport?.addEventListener("resize",i),window.visualViewport?.addEventListener("scroll",i),o?.onEvent?.("viewportChanged",i),l(),()=>{window.visualViewport?.removeEventListener("resize",i),window.visualViewport?.removeEventListener("scroll",i),o?.offEvent?.("viewportChanged",i),r.current!==null&&cancelAnimationFrame(r.current)}},[s,l]),n}const de=["â¤ï¸","ðŸ™Œ","ðŸ”¥","ðŸ‘","ðŸ˜¢","ðŸ˜","ðŸ˜®","ðŸ˜‚"],q=4;function ye({isOpen:s,onClose:n,postId:a,user:m}){const[r,l]=h.useState([]),[i,o]=h.useState(""),[d,v]=h.useState(!0),[g,w]=h.useState(null),[$,_]=h.useState({}),[V,z]=h.useState(!1),y=h.useRef(null),E=h.useRef(null),N=h.useRef(null),C=he(s),{uploadComment:B,isLoading:H}=oe(a,m.telegram_id),{handleCommentLike:D}=ce();h.useEffect(()=>{if(s&&a){F();const t=le(a,c=>{c.user_id!==m.telegram_id&&(c.parent_id?l(u=>u.map(x=>x.id===c.parent_id?{...x,replies:[...x.replies||[],c]}:x)):l(u=>[c,...u]))});return()=>t()}else l([]),o(""),w(null),_({})},[s,a]);const F=async()=>{if(!a)return;v(!0);const t=await ne(a,m.telegram_id);l(t),v(!1)},K=t=>{o(t.target.value),t.target.style.height="auto",t.target.style.height=`${Math.min(t.target.scrollHeight,80)}px`};h.useEffect(()=>{C.visible&&N.current&&N.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[C.visible]);const U=t=>{o(c=>c+t),y.current?.focus()},j=h.useRef(null),R=async()=>{if(!i.trim()||H||!a)return;const t=i.trim(),c=g?.id,u=g;j.current&&(j.current.style.transition="none",j.current.style.paddingBottom="calc(env(safe-area-inset-bottom, 0px) + 12px)"),z(!0),y.current?.blur(),o(""),w(null),y.current&&(y.current.style.height="auto"),setTimeout(()=>{z(!1),j.current&&(j.current.style.transition="",j.current.style.paddingBottom="")},600);const x=await B(t,c);x&&(u?l(f=>f.map(b=>{if(b.id===u.id){const k=[...b.replies||[],x];return _(X=>({...X,[b.id]:k.length})),{...b,replies:k}}return b})):(l(f=>[x,...f]),requestAnimationFrame(()=>{E.current?.scrollTo({top:0,behavior:"smooth"})})))},M=t=>{D(t,m.telegram_id,(c,u)=>{const x=f=>f.id===t.id?{...f,liked:c,likes_count:u}:f.replies?{...f,replies:f.replies.map(x)}:f;l(f=>f.map(x))})},L=t=>{const c=Date.now()-new Date(t).getTime(),u=Math.floor(c/6e4);if(u<1)return"now";if(u<60)return`${u}m`;const x=Math.floor(u/60);return x<24?`${x}h`:`${Math.floor(x/24)}d`},S=(t,c)=>$[t]??Math.min(q,c),W=(t,c)=>{const u=S(t,c);_(x=>({...x,[t]:Math.min(u+q,c)}))},J=(t,c)=>e.jsxs("div",{className:"flex gap-1.5 mt-2",children:[e.jsx("img",{src:t.user?.avatar_url||`https://i.pravatar.cc/150?u=${t.user_id}`,alt:"",className:"w-5 h-5 rounded-full object-cover flex-shrink-0 bg-[#333]"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-[12px] text-white mr-1",children:t.user?.username||t.user?.first_name}),e.jsx("span",{className:"text-[12px] text-white/85 leading-snug whitespace-pre-wrap break-words",children:t.content})]}),e.jsxs("div",{className:"flex items-center gap-2.5 mt-0.5",children:[e.jsx("span",{className:"text-[10px] text-gray-500",children:L(t.created_at)}),(t.likes_count||0)>0&&e.jsxs("span",{className:"text-[10px] text-gray-500 font-medium",children:[t.likes_count," ",t.likes_count===1?"like":"likes"]}),e.jsx("button",{className:"text-[10px] font-semibold text-gray-500 active:text-gray-300",onClick:()=>{w(c),y.current?.focus()},children:"Reply"})]})]}),e.jsx("button",{onClick:()=>M(t),className:"pt-0.5 active:scale-90 transition-transform",children:e.jsx(T,{className:`w-2 h-2 ${t.liked?"fill-red-500 text-red-500":"text-gray-500"}`})})]},t.id),Q=t=>{const c=t.replies||[],u=c.length,x=S(t.id,u),f=c.slice(0,x),b=u-x;return e.jsxs("div",{className:"mt-3 first:mt-0",children:[e.jsxs("div",{className:"flex gap-2.5",children:[e.jsx("img",{src:t.user?.avatar_url||`https://i.pravatar.cc/150?u=${t.user_id}`,alt:"",className:"w-8 h-8 rounded-full object-cover flex-shrink-0 bg-[#333]"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"font-semibold text-[13px] text-white mr-1.5",children:t.user?.username||t.user?.first_name}),e.jsx("span",{className:"text-[13px] text-white/90 leading-snug whitespace-pre-wrap break-words",children:t.content})]})}),e.jsxs("div",{className:"flex items-center gap-3 mt-1",children:[e.jsx("span",{className:"text-[11px] text-gray-500",children:L(t.created_at)}),(t.likes_count||0)>0&&e.jsxs("span",{className:"text-[11px] text-gray-500 font-semibold",children:[t.likes_count," ",t.likes_count===1?"like":"likes"]}),e.jsx("button",{className:"text-[11px] font-semibold text-gray-500 active:text-gray-300",onClick:()=>{w(t),y.current?.focus()},children:"Reply"})]})]}),e.jsx("button",{onClick:()=>M(t),className:"pt-1 active:scale-90 transition-transform",children:e.jsx(T,{className:`w-2.5 h-2.5 ${t.liked?"fill-red-500 text-red-500":"text-gray-500"}`})})]}),u>0&&e.jsxs("div",{className:"ml-10 mt-1.5",children:[f.map(k=>J(k,t)),b>0&&e.jsxs("button",{onClick:()=>W(t.id,u),className:"flex items-center gap-2 mt-2 text-[11px] font-semibold text-gray-500 active:text-gray-300",children:[e.jsx("div",{className:"w-5 h-px bg-gray-600"}),"View ",b," more ",b===1?"reply":"replies"]})]})]},t.id)};return e.jsx(I,{mode:"sync",children:s&&e.jsxs(e.Fragment,{children:[e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-black/70 backdrop-blur-[2px] z-[9998]",onClick:()=>{y.current?.blur(),n()}}),e.jsxs(P.div,{ref:j,initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"tween",duration:.18,ease:[.32,.72,0,1]},className:"fixed inset-x-0 bottom-0 z-[9999] bg-[#0c0c0c] rounded-t-[16px] flex flex-col overflow-hidden will-change-transform shadow-[0_-14px_60px_rgba(0,0,0,0.45)] border border-white/5 border-b-0",style:{height:"calc(var(--app-height) - 96px)",maxHeight:"calc(var(--app-height) - 72px)",paddingBottom:V?"calc(env(safe-area-inset-bottom, 0px) + 12px)":C.visible?"calc(var(--keyboard-height) + env(safe-area-inset-bottom, 0px) + 10px)":"calc(env(safe-area-inset-bottom, 0px) + 12px)",transition:V?"none":"padding-bottom 0.08s linear",transform:"translateZ(0)"},children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2 cursor-pointer flex-shrink-0",onClick:n,children:e.jsx("div",{className:"w-9 h-1 bg-[#555] rounded-full"})}),e.jsx("div",{className:"text-center pb-3 border-b border-[#1f1f1f] flex-shrink-0",children:e.jsx("h3",{className:"font-semibold text-white text-base tracking-tight",children:"Comments"})}),e.jsx("div",{ref:E,className:"flex-1 overflow-y-auto px-4 overscroll-contain",style:{minHeight:0,background:"linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0))"},children:d?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(A,{className:"w-6 h-6 animate-spin text-gray-400"})}):r.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"w-20 h-20 bg-[#363636] rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(ee,{className:"w-10 h-10 text-gray-500"})}),e.jsx("h3",{className:"font-semibold text-white text-xl mb-2",children:"No comments yet"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Start the conversation."})]}):e.jsx("div",{className:"py-4",children:r.map(t=>Q(t))})}),e.jsxs("div",{ref:N,className:"border-t border-[#1f1f1f] bg-[#0c0c0c] flex-shrink-0 pb-[env(safe-area-inset-bottom)]",children:[e.jsx("div",{className:"flex justify-around px-6 py-3",children:de.map(t=>e.jsx("button",{onClick:()=>U(t),className:"text-[22px] active:scale-90 transition-transform",children:t},t))}),g&&e.jsxs("div",{className:"flex justify-between items-center px-4 py-2 bg-[#363636] mx-4 rounded-lg text-xs text-gray-400 mb-2",children:[e.jsxs("span",{children:["Replying to ",e.jsx("span",{className:"font-semibold text-white",children:g.user?.username||"User"})]}),e.jsx("button",{onClick:()=>w(null),className:"p-1",children:e.jsx(te,{className:"w-3.5 h-3.5"})})]}),e.jsxs("div",{className:"flex items-center gap-3 px-4 pb-3",children:[e.jsx("img",{src:m.avatar_url||`https://i.pravatar.cc/150?u=${m.telegram_id}`,alt:"",className:"w-9 h-9 rounded-full object-cover flex-shrink-0 bg-[#333]"}),e.jsxs("div",{className:"flex-1 flex items-center bg-[#151515] border border-[#2e2e2e] rounded-full px-4 py-2 focus-within:border-[#444] transition-colors",children:[e.jsx("textarea",{ref:y,value:i,onChange:K,placeholder:g?"Reply...":"Add a comment...",rows:1,enterKeyHint:"send",className:"flex-1 bg-transparent text-white text-[15px] placeholder-[#888] focus:outline-none resize-none max-h-20",style:{minHeight:"22px"},onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),R())}}),i.trim()&&e.jsx("button",{onClick:R,disabled:H,className:"text-[#0095f6] font-semibold text-[15px] ml-2 disabled:opacity-50",children:H?e.jsx(A,{className:"w-5 h-5 animate-spin"}):"Post"})]})]})]})]})]})})}export{ye as C,fe as P,ve as V,pe as a,ge as b,we as c,be as d};
