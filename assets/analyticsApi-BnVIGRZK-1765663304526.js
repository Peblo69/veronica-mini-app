import{c as k,r as v,af as j,ag as C,ah as S,j as a,A as T,m as p,ad as q,ae as F,d as r}from"./index-pGZTRTd7-1765663304526.js";import{X as E}from"./x-C10_v8Mr-1765663304526.js";import{C as D}from"./useInViewport-CtomWSXY-1765663304526.js";const $=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]],P=k("grid-3x3",$);const A=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],R=k("share-2",A);function V({isOpen:e,onClose:n,userId:o,currentUserId:s,type:t,onUserClick:w}){const[f,c]=v.useState([]),[g,h]=v.useState(!0);v.useEffect(()=>{e&&b()},[e,o,t]);const b=async()=>{h(!0);const i=t==="followers"?await j(o,200):await C(o,200),m=await Promise.all(i.map(async l=>{if(l.telegram_id===s)return{...l,isFollowedByMe:!1};const d=await S(s,l.telegram_id);return{...l,isFollowedByMe:d}}));c(m),h(!1)},y=async(i,m)=>{m.stopPropagation(),c(l=>l.map(d=>d.telegram_id===i.telegram_id?{...d,followLoading:!0}:d));try{i.isFollowedByMe?(await q(s,i.telegram_id),c(l=>l.map(d=>d.telegram_id===i.telegram_id?{...d,isFollowedByMe:!1,followLoading:!1}:d))):(await F(s,i.telegram_id),c(l=>l.map(d=>d.telegram_id===i.telegram_id?{...d,isFollowedByMe:!0,followLoading:!1}:d)))}catch(l){console.error("Follow/unfollow error:",l),c(d=>d.map(_=>_.telegram_id===i.telegram_id?{..._,followLoading:!1}:_))}},x=i=>{w&&(w(i),n())};return a.jsx(T,{children:e&&a.jsxs(a.Fragment,{children:[a.jsx(p.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-black/80 backdrop-blur-md z-[100]",onClick:n}),a.jsx(p.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:30,stiffness:400},className:"fixed bottom-0 left-0 right-0 z-[101]",children:a.jsxs("div",{className:"bg-black rounded-t-3xl overflow-hidden shadow-2xl border-t border-white/[0.08]",children:[a.jsx("div",{className:"flex justify-center pt-3 pb-1",children:a.jsx("div",{className:"w-10 h-1 bg-white/20 rounded-full"})}),a.jsxs("div",{className:"flex items-center justify-between px-5 py-3 border-b border-white/[0.06]",children:[a.jsx("span",{className:"text-base font-semibold text-white capitalize",children:t}),a.jsx(p.button,{whileTap:{scale:.9},onClick:n,className:"w-8 h-8 flex items-center justify-center rounded-full bg-white/[0.08] hover:bg-white/[0.12] transition-colors",children:a.jsx(E,{className:"w-4 h-4 text-white/70"})})]}),a.jsx("div",{className:"overflow-y-auto max-h-[60vh] min-h-[180px]",children:g?a.jsx("div",{className:"px-4 py-2",children:[1,2,3,4,5,6].map(i=>a.jsxs("div",{className:"flex items-center gap-3 py-2.5 animate-pulse",children:[a.jsx("div",{className:"w-10 h-10 bg-white/[0.06] rounded-full shrink-0"}),a.jsxs("div",{className:"flex-1",children:[a.jsx("div",{className:"h-3.5 bg-white/[0.06] rounded w-24 mb-1.5"}),a.jsx("div",{className:"h-2.5 bg-white/[0.06] rounded w-16"})]}),a.jsx("div",{className:"w-[72px] h-7 bg-white/[0.06] rounded-full"})]},i))}):f.length===0?a.jsx("div",{className:"py-16 text-center",children:a.jsx("p",{className:"text-white/30 text-sm",children:t==="followers"?"No followers yet":"Not following anyone"})}):a.jsx("div",{className:"px-3 py-1",children:f.map((i,m)=>a.jsxs(p.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:m*.02,duration:.2},className:"w-full flex items-center gap-3 px-2 py-2.5 rounded-xl hover:bg-white/[0.04] active:bg-white/[0.08] transition-all cursor-pointer",onClick:()=>x(i),children:[a.jsxs("div",{className:"relative shrink-0",children:[a.jsx("img",{src:i.avatar_url||`https://i.pravatar.cc/150?u=${i.telegram_id}`,alt:i.first_name||"User",className:"w-10 h-10 rounded-full object-cover ring-1 ring-white/[0.08]"}),i.is_verified&&a.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 bg-black rounded-full p-[1px]",children:a.jsx(D,{className:"w-3.5 h-3.5 text-blue-400 fill-blue-400"})})]}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("span",{className:"font-medium text-white text-[13px] truncate block",children:[i.first_name," ",i.last_name]}),a.jsx("span",{className:"text-xs text-white/40 truncate block",children:i.username?`@${i.username}`:i.is_creator?"Creator":""})]}),i.telegram_id!==s&&a.jsx(p.button,{whileTap:{scale:.95},onClick:l=>y(i,l),disabled:i.followLoading,className:`px-4 py-1.5 rounded-full text-xs font-semibold transition-all shrink-0 min-w-[72px] ${i.followLoading?"bg-white/[0.06] text-white/40":i.isFollowedByMe?"bg-white/[0.08] text-white/70 hover:bg-white/[0.12]":"bg-white text-black hover:bg-white/90"}`,children:i.followLoading?a.jsx("span",{className:"inline-block w-3 h-3 border-[1.5px] border-white/20 border-t-white/60 rounded-full animate-spin"}):i.isFollowedByMe?"Following":"Follow"})]},i.telegram_id))})}),a.jsx("div",{className:"h-8 bg-black"})]})})]})})}function z(e){v.useEffect(()=>{if(typeof window>"u"||!e)return;const n=typeof window.requestIdleCallback=="function"?window.requestIdleCallback.bind(window):void 0,o=typeof window.cancelIdleCallback=="function"?window.cancelIdleCallback.bind(window):void 0;let s=!1,t=null,w=null;const f=()=>{if(s)return;const c=new Image;c.src=e};return n?t=n(()=>f()):w=window.setTimeout(f,250),()=>{s=!0,t!==null&&o&&o(t),w!==null&&window.clearTimeout(w)}},[e])}const u={effectiveType:"4g",saveData:!1,downlink:10};function O(){const[e,n]=v.useState(()=>{if(typeof navigator>"u")return u;const t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return t?{effectiveType:t.effectiveType||u.effectiveType,saveData:t.saveData||!1,downlink:t.downlink||u.downlink}:u});v.useEffect(()=>{const t=navigator?.connection||navigator?.mozConnection||navigator?.webkitConnection;if(!t)return;const w=()=>{n({effectiveType:t.effectiveType||u.effectiveType,saveData:!!t.saveData,downlink:t.downlink||u.downlink})};return t.addEventListener?.("change",w),()=>t.removeEventListener?.("change",w)},[]);const o=e.effectiveType==="slow-2g"||e.effectiveType==="2g",s=e.saveData;return{...e,isSlow:o,isDataSaver:s}}async function W(e){try{const{count:n}=await r.from("follows").select("*",{count:"exact",head:!0}).eq("following_id",e),{data:o}=await r.from("posts").select("like_count, comment_count, repost_count, view_count").eq("creator_id",e),s=o?.reduce((m,l)=>m+(l.like_count||0),0)||0,t=o?.reduce((m,l)=>m+(l.comment_count||0),0)||0,w=o?.reduce((m,l)=>m+(l.repost_count||0),0)||0,{count:f}=await r.from("subscriptions").select("*",{count:"exact",head:!0}).eq("creator_id",e).eq("status","active");let c=0,g=0,h=0;try{const{count:m}=await r.from("profile_views").select("*",{count:"exact",head:!0}).eq("profile_id",e);c=m||0;const l=new Date().toISOString().split("T")[0],{count:d}=await r.from("profile_views").select("*",{count:"exact",head:!0}).eq("profile_id",e).gte("viewed_at",l);g=d||0;const _=new Date(Date.now()-10080*60*1e3).toISOString(),{count:N}=await r.from("profile_views").select("*",{count:"exact",head:!0}).eq("profile_id",e).gte("viewed_at",_);h=N||0}catch{}const b=new Date(Date.now()-10080*60*1e3).toISOString(),{count:y}=await r.from("follows").select("*",{count:"exact",head:!0}).eq("following_id",e).gte("created_at",b);let x=0;try{const{data:m}=await r.from("orders").select("net").eq("creator_id",e).eq("status","completed");x=m?.reduce((l,d)=>l+(d.net||0),0)||0}catch{}const i=o?.reduce((m,l)=>m+(l.view_count||0),0)||0;return{total_followers:n||0,total_subscribers:f||0,total_posts:o?.length||0,total_likes:s,total_comments:t,total_shares:w,total_profile_views:c,total_post_views:i,views_today:g,views_this_week:h,views_this_month:h,followers_today:0,followers_this_week:y||0,total_earnings:x}}catch(n){return console.error("[Analytics] Exception:",n),null}}async function G(e,n=7){try{const o=new Date(Date.now()-n*24*60*60*1e3).toISOString(),{data:s,error:t}=await r.from("profile_views").select("viewed_at").eq("profile_id",e).gte("viewed_at",o);if(t)return console.warn("[Analytics] profile_views table not found, using fallback"),[];const w={};for(let f=0;f<n;f++){const c=new Date(Date.now()-(n-1-f)*24*60*60*1e3);w[c.toISOString().split("T")[0]]=0}return s?.forEach(f=>{const c=new Date(f.viewed_at).toISOString().split("T")[0];w[c]!==void 0&&w[c]++}),Object.entries(w).map(([f,c])=>({date:f,views:c}))}catch(o){return console.error("[Analytics] Exception:",o),[]}}async function H(e,n=10){try{const{data:o,error:s}=await r.from("profile_views").select(`
        viewer_id,
        viewed_at,
        source,
        viewer:users!profile_views_viewer_id_fkey(
          username,
          first_name,
          avatar_url,
          is_verified
        )
      `).eq("profile_id",e).not("viewer_id","is",null).neq("viewer_id",e).order("viewed_at",{ascending:!1}).limit(n);return s?(console.warn("[Analytics] Could not fetch visitors:",s.message),[]):(o||[]).map(t=>({viewer_id:t.viewer_id,username:t.viewer?.username||null,first_name:t.viewer?.first_name||null,avatar_url:t.viewer?.avatar_url||null,is_verified:t.viewer?.is_verified||!1,viewed_at:t.viewed_at,source:t.source||"feed"}))}catch(o){return console.error("[Analytics] Exception:",o),[]}}async function K(e,n=5){try{const{data:o,error:s}=await r.from("posts").select("id, content, media_url, media_type, like_count, comment_count, repost_count, view_count, created_at").eq("creator_id",e).order("like_count",{ascending:!1}).limit(n);return s?(console.error("[Analytics] Error fetching top posts:",s),[]):(o||[]).map(t=>({...t,engagement_score:(t.like_count||0)+(t.comment_count||0)*2+(t.repost_count||0)*3}))}catch(o){return console.error("[Analytics] Exception:",o),[]}}async function Q(e,n,o="feed"){try{if(n&&n===e)return;await r.from("profile_views").insert({profile_id:e,viewer_id:n||null,source:o})}catch(s){console.warn("[Analytics] Failed to record view:",s)}}function X(e,n){const o=r.channel(`profile_views_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"profile_views",filter:`profile_id=eq.${e}`},()=>n("view")).subscribe(),s=r.channel(`follows_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"follows",filter:`following_id=eq.${e}`},()=>n("follow")).subscribe(),t=r.channel(`likes_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"likes"},()=>n("like")).subscribe(),w=r.channel(`comments_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"comments"},()=>n("comment")).subscribe(),f=r.channel(`earnings_${e}`).on("postgres_changes",{event:"*",schema:"public",table:"orders",filter:`creator_id=eq.${e}`},()=>n("earning")).subscribe(),c=r.channel(`post_views_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"post_views"},()=>n("post_view")).subscribe();return()=>{r.removeChannel(o),r.removeChannel(s),r.removeChannel(t),r.removeChannel(w),r.removeChannel(f),r.removeChannel(c)}}function J(e,n,o,s){if(s===0)return 0;const t=e+n*2+o*3;return Math.min(100,t/s*100)}function Y(e){return e>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":e>=1e3?(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":e.toString()}function Z(e){return e>=1e3?"$"+(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":"$"+e.toFixed(2)}export{V as F,P as G,R as S,G as a,H as b,K as c,J as d,Z as e,Y as f,W as g,z as h,Q as r,X as s,O as u};
