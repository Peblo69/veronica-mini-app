import{c as k,r as p,ac as j,ad as N,ae as C,j as a,A as S,m as _,aa as T,ab as F,d as c}from"./index-B9w3hezZ-1765579571845.js";import{X as q}from"./x-C-mKv8BI-1765579571845.js";import{C as D}from"./useInViewport-DN-JA0Z8-1765579571845.js";const E=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]],B=k("grid-3x3",E);const A=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],P=k("share-2",A);function R({isOpen:e,onClose:n,userId:o,currentUserId:l,type:t,onUserClick:d}){const[w,s]=p.useState([]),[g,h]=p.useState(!0);p.useEffect(()=>{e&&x()},[e,o,t]);const x=async()=>{h(!0);const i=t==="followers"?await j(o,200):await N(o,200),u=await Promise.all(i.map(async f=>{if(f.telegram_id===l)return{...f,isFollowedByMe:!1};const r=await C(l,f.telegram_id);return{...f,isFollowedByMe:r}}));s(u),h(!1)},y=async(i,u)=>{u.stopPropagation(),s(f=>f.map(r=>r.telegram_id===i.telegram_id?{...r,followLoading:!0}:r));try{i.isFollowedByMe?(await T(l,i.telegram_id),s(f=>f.map(r=>r.telegram_id===i.telegram_id?{...r,isFollowedByMe:!1,followLoading:!1}:r))):(await F(l,i.telegram_id),s(f=>f.map(r=>r.telegram_id===i.telegram_id?{...r,isFollowedByMe:!0,followLoading:!1}:r)))}catch(f){console.error("Follow/unfollow error:",f),s(r=>r.map(b=>b.telegram_id===i.telegram_id?{...b,followLoading:!1}:b))}},m=i=>{d&&(d(i),n())};return a.jsx(S,{children:e&&a.jsxs(a.Fragment,{children:[a.jsx(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-black/80 backdrop-blur-md z-[100]",onClick:n}),a.jsx(_.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",damping:30,stiffness:400},className:"fixed bottom-0 left-0 right-0 z-[101]",children:a.jsxs("div",{className:"bg-black rounded-t-3xl overflow-hidden shadow-2xl border-t border-white/[0.08]",children:[a.jsx("div",{className:"flex justify-center pt-3 pb-1",children:a.jsx("div",{className:"w-10 h-1 bg-white/20 rounded-full"})}),a.jsxs("div",{className:"flex items-center justify-between px-5 py-3 border-b border-white/[0.06]",children:[a.jsx("span",{className:"text-base font-semibold text-white capitalize",children:t}),a.jsx(_.button,{whileTap:{scale:.9},onClick:n,className:"w-8 h-8 flex items-center justify-center rounded-full bg-white/[0.08] hover:bg-white/[0.12] transition-colors",children:a.jsx(q,{className:"w-4 h-4 text-white/70"})})]}),a.jsx("div",{className:"overflow-y-auto max-h-[60vh] min-h-[180px]",children:g?a.jsx("div",{className:"px-4 py-2",children:[1,2,3,4,5,6].map(i=>a.jsxs("div",{className:"flex items-center gap-3 py-2.5 animate-pulse",children:[a.jsx("div",{className:"w-10 h-10 bg-white/[0.06] rounded-full shrink-0"}),a.jsxs("div",{className:"flex-1",children:[a.jsx("div",{className:"h-3.5 bg-white/[0.06] rounded w-24 mb-1.5"}),a.jsx("div",{className:"h-2.5 bg-white/[0.06] rounded w-16"})]}),a.jsx("div",{className:"w-[72px] h-7 bg-white/[0.06] rounded-full"})]},i))}):w.length===0?a.jsx("div",{className:"py-16 text-center",children:a.jsx("p",{className:"text-white/30 text-sm",children:t==="followers"?"No followers yet":"Not following anyone"})}):a.jsx("div",{className:"px-3 py-1",children:w.map((i,u)=>a.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:u*.02,duration:.2},className:"w-full flex items-center gap-3 px-2 py-2.5 rounded-xl hover:bg-white/[0.04] active:bg-white/[0.08] transition-all cursor-pointer",onClick:()=>m(i),children:[a.jsxs("div",{className:"relative shrink-0",children:[a.jsx("img",{src:i.avatar_url||`https://i.pravatar.cc/150?u=${i.telegram_id}`,alt:i.first_name||"User",className:"w-10 h-10 rounded-full object-cover ring-1 ring-white/[0.08]"}),i.is_verified&&a.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 bg-black rounded-full p-[1px]",children:a.jsx(D,{className:"w-3.5 h-3.5 text-blue-400 fill-blue-400"})})]}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("span",{className:"font-medium text-white text-[13px] truncate block",children:[i.first_name," ",i.last_name]}),a.jsx("span",{className:"text-xs text-white/40 truncate block",children:i.username?`@${i.username}`:i.is_creator?"Creator":""})]}),i.telegram_id!==l&&a.jsx(_.button,{whileTap:{scale:.95},onClick:f=>y(i,f),disabled:i.followLoading,className:`px-4 py-1.5 rounded-full text-xs font-semibold transition-all shrink-0 min-w-[72px] ${i.followLoading?"bg-white/[0.06] text-white/40":i.isFollowedByMe?"bg-white/[0.08] text-white/70 hover:bg-white/[0.12]":"bg-white text-black hover:bg-white/90"}`,children:i.followLoading?a.jsx("span",{className:"inline-block w-3 h-3 border-[1.5px] border-white/20 border-t-white/60 rounded-full animate-spin"}):i.isFollowedByMe?"Following":"Follow"})]},i.telegram_id))})}),a.jsx("div",{className:"h-8 bg-black"})]})})]})})}function z(e){p.useEffect(()=>{if(typeof window>"u"||!e)return;const n=typeof window.requestIdleCallback=="function"?window.requestIdleCallback.bind(window):void 0,o=typeof window.cancelIdleCallback=="function"?window.cancelIdleCallback.bind(window):void 0;let l=!1,t=null,d=null;const w=()=>{if(l)return;const s=new Image;s.src=e};return n?t=n(()=>w()):d=window.setTimeout(w,250),()=>{l=!0,t!==null&&o&&o(t),d!==null&&window.clearTimeout(d)}},[e])}const v={effectiveType:"4g",saveData:!1,downlink:10};function O(){const[e,n]=p.useState(()=>{if(typeof navigator>"u")return v;const t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return t?{effectiveType:t.effectiveType||v.effectiveType,saveData:t.saveData||!1,downlink:t.downlink||v.downlink}:v});p.useEffect(()=>{const t=navigator?.connection||navigator?.mozConnection||navigator?.webkitConnection;if(!t)return;const d=()=>{n({effectiveType:t.effectiveType||v.effectiveType,saveData:!!t.saveData,downlink:t.downlink||v.downlink})};return t.addEventListener?.("change",d),()=>t.removeEventListener?.("change",d)},[]);const o=e.effectiveType==="slow-2g"||e.effectiveType==="2g",l=e.saveData;return{...e,isSlow:o,isDataSaver:l}}async function V(e){try{const{count:n}=await c.from("follows").select("*",{count:"exact",head:!0}).eq("following_id",e),{data:o}=await c.from("posts").select("like_count, comment_count, repost_count, view_count").eq("creator_id",e),l=o?.reduce((m,i)=>m+(i.like_count||0),0)||0,t=o?.reduce((m,i)=>m+(i.comment_count||0),0)||0,d=o?.reduce((m,i)=>m+(i.repost_count||0),0)||0,{count:w}=await c.from("subscriptions").select("*",{count:"exact",head:!0}).eq("creator_id",e).eq("status","active");let s=0,g=0,h=0;try{const{count:m}=await c.from("profile_views").select("*",{count:"exact",head:!0}).eq("profile_id",e);s=m||0;const i=new Date().toISOString().split("T")[0],{count:u}=await c.from("profile_views").select("*",{count:"exact",head:!0}).eq("profile_id",e).gte("viewed_at",i);g=u||0;const f=new Date(Date.now()-10080*60*1e3).toISOString(),{count:r}=await c.from("profile_views").select("*",{count:"exact",head:!0}).eq("profile_id",e).gte("viewed_at",f);h=r||0}catch{}const x=new Date(Date.now()-10080*60*1e3).toISOString(),{count:y}=await c.from("follows").select("*",{count:"exact",head:!0}).eq("following_id",e).gte("created_at",x);return{total_followers:n||0,total_subscribers:w||0,total_posts:o?.length||0,total_likes:l,total_comments:t,total_shares:d,total_profile_views:s,views_today:g,views_this_week:h,views_this_month:h,followers_today:0,followers_this_week:y||0,total_earnings:0}}catch(n){return console.error("[Analytics] Exception:",n),null}}async function W(e,n=7){try{const o=new Date(Date.now()-n*24*60*60*1e3).toISOString(),{data:l,error:t}=await c.from("profile_views").select("viewed_at").eq("profile_id",e).gte("viewed_at",o);if(t)return console.warn("[Analytics] profile_views table not found, using fallback"),[];const d={};for(let w=0;w<n;w++){const s=new Date(Date.now()-(n-1-w)*24*60*60*1e3);d[s.toISOString().split("T")[0]]=0}return l?.forEach(w=>{const s=new Date(w.viewed_at).toISOString().split("T")[0];d[s]!==void 0&&d[s]++}),Object.entries(d).map(([w,s])=>({date:w,views:s}))}catch(o){return console.error("[Analytics] Exception:",o),[]}}async function G(e,n=10){try{const{data:o,error:l}=await c.from("profile_views").select(`
        viewer_id,
        viewed_at,
        source,
        viewer:users!profile_views_viewer_id_fkey(
          username,
          first_name,
          avatar_url,
          is_verified
        )
      `).eq("profile_id",e).not("viewer_id","is",null).neq("viewer_id",e).order("viewed_at",{ascending:!1}).limit(n);return l?(console.warn("[Analytics] Could not fetch visitors:",l.message),[]):(o||[]).map(t=>({viewer_id:t.viewer_id,username:t.viewer?.username||null,first_name:t.viewer?.first_name||null,avatar_url:t.viewer?.avatar_url||null,is_verified:t.viewer?.is_verified||!1,viewed_at:t.viewed_at,source:t.source||"feed"}))}catch(o){return console.error("[Analytics] Exception:",o),[]}}async function H(e,n=5){try{const{data:o,error:l}=await c.from("posts").select("id, content, media_url, media_type, like_count, comment_count, repost_count, view_count, created_at").eq("creator_id",e).order("like_count",{ascending:!1}).limit(n);return l?(console.error("[Analytics] Error fetching top posts:",l),[]):(o||[]).map(t=>({...t,engagement_score:(t.like_count||0)+(t.comment_count||0)*2+(t.repost_count||0)*3}))}catch(o){return console.error("[Analytics] Exception:",o),[]}}async function K(e,n,o="feed"){try{if(n&&n===e)return;await c.from("profile_views").insert({profile_id:e,viewer_id:n||null,source:o})}catch(l){console.warn("[Analytics] Failed to record view:",l)}}function Q(e,n){const o=c.channel(`profile_views_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"profile_views",filter:`profile_id=eq.${e}`},()=>n("view")).subscribe(),l=c.channel(`follows_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"follows",filter:`following_id=eq.${e}`},()=>n("follow")).subscribe(),t=c.channel(`likes_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"likes"},()=>n("like")).subscribe();return()=>{c.removeChannel(o),c.removeChannel(l),c.removeChannel(t)}}function X(e,n,o,l){if(l===0)return 0;const t=e+n*2+o*3;return Math.min(100,t/l*100)}function J(e){return e>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":e>=1e3?(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":e.toString()}function Y(e){return e>=1e3?"$"+(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":"$"+e.toFixed(2)}export{R as F,B as G,P as S,W as a,G as b,H as c,X as d,Y as e,J as f,V as g,z as h,K as r,Q as s,O as u};
