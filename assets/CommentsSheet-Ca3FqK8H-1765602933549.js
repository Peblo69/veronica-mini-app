const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B8OMBSCI-1765602933549.js","assets/index-z1MpU0lN-1765602933549.css"])))=>i.map(i=>d[i]);
import{c as le,d as g,t as R,r as f,u as oe,o as ce,j as t,A as de,m as B,N as me,_ as ue}from"./index-B8OMBSCI-1765602933549.js";import{L as O}from"./loader-circle-CyNTWuvu-1765602933549.js";import{X as xe}from"./x-C7ybDNyc-1765602933549.js";import{H as G}from"./heart-Dqwbga55-1765602933549.js";import{T as J}from"./trash-2-CpOdj0z1-1765602933549.js";import{F as Q}from"./flag-BGcQJ3ur-1765602933549.js";const fe=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]],X=le("ellipsis",fe);async function pe(n,c){const{data:r,error:h}=await g.from("comments").select("*, user:users!user_id(*)").eq("post_id",n).is("parent_id",null).order("created_at",{ascending:!1});if(h||!r)return[];let s=new Set;if(c){const{data:i}=await g.from("comment_likes").select("comment_id").eq("user_id",c);s=new Set(i?.map(d=>d.comment_id)||[])}return await Promise.all(r.map(async i=>{const{data:d}=await g.from("comments").select("*, user:users!user_id(*)").eq("parent_id",i.id).order("created_at",{ascending:!0});return{...i,liked:s.has(i.id),replies:(d||[]).map(x=>({...x,liked:s.has(x.id)}))}}))}async function he(n,c,r,h){const{data:s,error:u}=await g.from("comments").insert({post_id:n,user_id:c,content:r,parent_id:h||null}).select("*, user:users!user_id(*)").single();if(u)return console.error("Add comment error:",u),R.error("Failed to add comment"),null;await g.rpc("increment_comments",{p_post_id:n});const{data:i}=await g.from("posts").select("creator_id").eq("id",n).single();return i&&i.creator_id!==c&&await g.from("notifications").insert({user_id:i.creator_id,from_user_id:c,type:"comment",content:"commented on your post",reference_id:n.toString(),reference_type:"post"}),s}async function ge(n,c,r){await g.from("comments").delete().eq("parent_id",n);const{error:h}=await g.from("comments").delete().eq("id",n).eq("user_id",c);return h||await g.rpc("decrement_comments",{p_post_id:r}),!h}async function be(n,c){const{error:r}=await g.from("comment_likes").insert({comment_id:n,user_id:c});return!r}async function we(n,c){const{error:r}=await g.from("comment_likes").delete().eq("comment_id",n).eq("user_id",c);return!r}function ve(n,c){const r=typeof c=="function"?{onInsert:c}:c,h=g.channel(`comments:${n}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"comments",filter:`post_id=eq.${n}`},async s=>{const{data:u}=await g.from("comments").select("*, user:users!user_id(*)").eq("id",s.new.id).single();u&&r.onInsert&&r.onInsert(u)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"comments",filter:`post_id=eq.${n}`},async s=>{const{data:u}=await g.from("comments").select("*, user:users!user_id(*)").eq("id",s.new.id).single();u&&r.onUpdate&&r.onUpdate(u)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"comments",filter:`post_id=eq.${n}`},s=>{r.onDelete&&r.onDelete(s.old.id)}).subscribe();return()=>{g.removeChannel(h)}}function _e(n,c){const[r,h]=f.useState(!1),[s,u]=f.useState(null);return{uploadComment:f.useCallback(async(d,x)=>{if(!n||!d.trim()||r)return null;h(!0),u(null);try{return await he(n,c,d.trim(),x)}catch(b){const v=b instanceof Error?b.message:"Failed to post comment";return console.error("Error uploading comment:",b),u(v),null}finally{h(!1)}},[n,c,r]),isLoading:r,error:s}}function je(){const[n,c]=f.useState(!1),r=f.useCallback(async(s,u,i)=>{if(n)return;c(!0);const d=s.liked??!1,x=s.likes_count??0,b=!d,v=b?x+1:Math.max(0,x-1);i?.(b,v);try{d?await oe(u,s.id):await ce(u,s.id)}catch(w){console.error("Error updating post like:",w),i?.(d,x)}finally{c(!1)}},[n]),h=f.useCallback(async(s,u,i)=>{if(n)return;c(!0);const d=s.liked??!1,x=s.likes_count??0,b=!d,v=b?x+1:Math.max(0,x-1);i?.(b,v);try{d?await we(s.id,u):await be(s.id,u)}catch(w){console.error("Error updating comment like:",w),i?.(d,x)}finally{c(!1)}},[n]);return{handlePostLike:r,handleCommentLike:h,loading:n}}function ye(n=!0){const[c,r]=f.useState({visible:!1,height:0}),h=f.useRef(0),s=f.useRef(null),u=f.useCallback(()=>{if(!n)return;const i=window.visualViewport,d=window.Telegram?.WebApp;let x=0;if(i&&(x=Math.max(0,window.innerHeight-i.height-i.offsetTop)),d?.viewportHeight&&d?.viewportStableHeight){const b=Math.max(0,d.viewportStableHeight-d.viewportHeight);x=Math.max(x,b)}Math.abs(x-h.current)>20&&(h.current=x,r({visible:x>100,height:x}))},[n]);return f.useEffect(()=>{if(!n)return;const i=()=>{s.current!==null&&cancelAnimationFrame(s.current),s.current=requestAnimationFrame(u)},d=window.Telegram?.WebApp;return window.visualViewport?.addEventListener("resize",i),window.visualViewport?.addEventListener("scroll",i),d?.onEvent?.("viewportChanged",i),u(),()=>{window.visualViewport?.removeEventListener("resize",i),window.visualViewport?.removeEventListener("scroll",i),d?.offEvent?.("viewportChanged",i),s.current!==null&&cancelAnimationFrame(s.current)}},[n,u]),c}const ke=["â¤ï¸","ðŸ™Œ","ðŸ”¥","ðŸ‘","ðŸ˜¢","ðŸ˜","ðŸ˜®","ðŸ˜‚"],Z=4;function qe({isOpen:n,onClose:c,postId:r,postCreatorId:h,user:s}){const[u,i]=f.useState([]),[d,x]=f.useState(""),[b,v]=f.useState(!0),[w,N]=f.useState(null),[Y,L]=f.useState({}),[H,M]=f.useState(!1),[C,y]=f.useState(null),[E,F]=f.useState(null),_=f.useRef(null),$=f.useRef(null),S=f.useRef(null),q=ye(n),{uploadComment:I,isLoading:T}=_e(r,s.telegram_id),{handleCommentLike:ee}=je();f.useEffect(()=>{if(n&&r){te();const e=ve(r,{onInsert:a=>{a.user_id!==s.telegram_id&&(a.parent_id?i(m=>m.map(o=>o.id===a.parent_id?{...o,replies:[...o.replies||[],a]}:o)):i(m=>[a,...m]))},onUpdate:a=>{i(m=>m.map(o=>o.id===a.id?{...o,likes_count:a.likes_count}:o.replies?.some(l=>l.id===a.id)?{...o,replies:o.replies.map(l=>l.id===a.id?{...l,likes_count:a.likes_count}:l)}:o))},onDelete:a=>{i(m=>m.filter(l=>l.id!==a).map(l=>({...l,replies:(l.replies||[]).filter(p=>p.id!==a)})))}});return()=>e()}else i([]),x(""),N(null),L({}),y(null)},[n,r]);const te=async()=>{if(!r)return;v(!0);const e=await pe(r,s.telegram_id);i(e),v(!1)},se=e=>{x(e.target.value),e.target.style.height="auto",e.target.style.height=`${Math.min(e.target.scrollHeight,80)}px`};f.useEffect(()=>{q.visible&&S.current&&S.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[q.visible]);const ie=e=>{x(a=>a+e),_.current?.focus()},k=f.useRef(null),A=async()=>{if(!d.trim()||T||!r)return;const e=d.trim(),a=w?.id,m=w;k.current&&(k.current.style.transition="none",k.current.style.paddingBottom="calc(env(safe-area-inset-bottom, 0px) + 12px)"),M(!0),_.current?.blur(),x(""),N(null),_.current&&(_.current.style.height="auto"),setTimeout(()=>{M(!1),k.current&&(k.current.style.transition="",k.current.style.paddingBottom="")},600);const o=await I(e,a);o&&(m?i(l=>l.map(p=>{if(p.id===m.id){const j=[...p.replies||[],o];return L(D=>({...D,[p.id]:j.length})),{...p,replies:j}}return p})):(i(l=>[o,...l]),requestAnimationFrame(()=>{$.current?.scrollTo({top:0,behavior:"smooth"})})))},P=e=>{ee(e,s.telegram_id,(a,m)=>{const o=l=>l.id===e.id?{...l,liked:a,likes_count:m}:l.replies?{...l,replies:l.replies.map(o)}:l;i(l=>l.map(o))})},z=e=>e.user_id===s.telegram_id||h===s.telegram_id,V=async e=>{if(!r)return;F(e.id),y(null);const a=h===s.telegram_id,m=e.user_id===s.telegram_id;let o=!1;if(m)o=await ge(e.id,s.telegram_id,r);else if(a){const{supabase:l}=await ue(async()=>{const{supabase:j}=await import("./index-B8OMBSCI-1765602933549.js").then(D=>D.aG);return{supabase:j}},__vite__mapDeps([0,1]));await l.from("comments").delete().eq("parent_id",e.id);const{error:p}=await l.from("comments").delete().eq("id",e.id);p||(await l.rpc("decrement_comments",{p_post_id:r}),o=!0)}o?(e.parent_id?i(l=>l.map(p=>p.id===e.parent_id?{...p,replies:(p.replies||[]).filter(j=>j.id!==e.id)}:p)):i(l=>l.filter(p=>p.id!==e.id)),R.success("Comment deleted")):R.error("Failed to delete comment"),F(null)},K=e=>{y(null),R.success("Comment reported")},U=e=>{const a=Date.now()-new Date(e).getTime(),m=Math.floor(a/6e4);if(m<1)return"now";if(m<60)return`${m}m`;const o=Math.floor(m/60);return o<24?`${o}h`:`${Math.floor(o/24)}d`},W=(e,a)=>Y[e]??Math.min(Z,a),ne=(e,a)=>{const m=W(e,a);L(o=>({...o,[e]:Math.min(m+Z,a)}))},re=(e,a)=>t.jsxs("div",{className:"flex gap-1.5 mt-2 relative",children:[t.jsx("img",{src:e.user?.avatar_url||`https://i.pravatar.cc/150?u=${e.user_id}`,alt:"",className:"w-5 h-5 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{children:[t.jsx("span",{className:"font-semibold text-[12px] text-white mr-1",children:e.user?.username||e.user?.first_name}),t.jsx("span",{className:"text-[12px] text-white/85 leading-snug whitespace-pre-wrap break-words",children:e.content})]}),t.jsxs("div",{className:"flex items-center gap-3 mt-0.5",children:[t.jsx("span",{className:"text-[10px] text-gray-500",children:U(e.created_at)}),t.jsx("button",{className:"text-[10px] font-semibold text-gray-500 active:text-gray-300",onClick:()=>{N(a),_.current?.focus()},children:"Reply"}),t.jsxs("button",{onClick:()=>P(e),className:"flex items-center gap-1 active:scale-95 transition-transform",children:[t.jsx(G,{className:`w-3 h-3 ${e.liked?"fill-red-500 text-red-500":"text-gray-500"}`}),(e.likes_count||0)>0&&t.jsx("span",{className:`text-[10px] font-medium ${e.liked?"text-red-500":"text-gray-500"}`,children:e.likes_count})]})]})]}),t.jsx("div",{className:"flex items-start pt-0.5",children:t.jsx("button",{onClick:()=>y(C===e.id?null:e.id),className:"active:scale-90 transition-transform p-0.5",children:t.jsx(X,{className:"w-3 h-3 text-gray-500"})})}),C===e.id&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>y(null)}),t.jsxs("div",{className:"absolute right-0 top-6 bg-[#262626] rounded-lg shadow-xl z-20 overflow-hidden min-w-[140px] border border-white/10",children:[z(e)&&t.jsxs("button",{onClick:()=>V(e),disabled:E===e.id,className:"w-full flex items-center gap-2 px-4 py-2.5 text-red-500 hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(J,{className:"w-4 h-4"}),E===e.id?"Deleting...":"Delete"]}),t.jsxs("button",{onClick:()=>K(),className:"w-full flex items-center gap-2 px-4 py-2.5 text-white hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(Q,{className:"w-4 h-4"}),"Report"]})]})]})]},e.id),ae=e=>{const a=e.replies||[],m=a.length,o=W(e.id,m),l=a.slice(0,o),p=m-o;return t.jsxs("div",{className:"mt-3 first:mt-0 relative",children:[t.jsxs("div",{className:"flex gap-2.5",children:[t.jsx("img",{src:e.user?.avatar_url||`https://i.pravatar.cc/150?u=${e.user_id}`,alt:"",className:"w-8 h-8 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"flex items-start gap-2",children:t.jsxs("div",{className:"flex-1",children:[t.jsx("span",{className:"font-semibold text-[13px] text-white mr-1.5",children:e.user?.username||e.user?.first_name}),t.jsx("span",{className:"text-[13px] text-white/90 leading-snug whitespace-pre-wrap break-words",children:e.content})]})}),t.jsxs("div",{className:"flex items-center gap-3 mt-1",children:[t.jsx("span",{className:"text-[11px] text-gray-500",children:U(e.created_at)}),t.jsx("button",{className:"text-[11px] font-semibold text-gray-500 active:text-gray-300",onClick:()=>{N(e),_.current?.focus()},children:"Reply"}),t.jsxs("button",{onClick:()=>P(e),className:"flex items-center gap-1 active:scale-95 transition-transform",children:[t.jsx(G,{className:`w-3.5 h-3.5 ${e.liked?"fill-red-500 text-red-500":"text-gray-500"}`}),(e.likes_count||0)>0&&t.jsx("span",{className:`text-[11px] font-semibold ${e.liked?"text-red-500":"text-gray-500"}`,children:e.likes_count})]})]})]}),t.jsx("div",{className:"flex items-start pt-1",children:t.jsx("button",{onClick:()=>y(C===e.id?null:e.id),className:"active:scale-90 transition-transform p-0.5",children:t.jsx(X,{className:"w-3.5 h-3.5 text-gray-500"})})})]}),C===e.id&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>y(null)}),t.jsxs("div",{className:"absolute right-0 top-8 bg-[#262626] rounded-lg shadow-xl z-20 overflow-hidden min-w-[140px] border border-white/10",children:[z(e)&&t.jsxs("button",{onClick:()=>V(e),disabled:E===e.id,className:"w-full flex items-center gap-2 px-4 py-2.5 text-red-500 hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(J,{className:"w-4 h-4"}),E===e.id?"Deleting...":"Delete"]}),t.jsxs("button",{onClick:()=>K(),className:"w-full flex items-center gap-2 px-4 py-2.5 text-white hover:bg-[#363636] transition-colors text-left text-[13px]",children:[t.jsx(Q,{className:"w-4 h-4"}),"Report"]})]})]}),m>0&&t.jsxs("div",{className:"ml-10 mt-1.5",children:[l.map(j=>re(j,e)),p>0&&t.jsxs("button",{onClick:()=>ne(e.id,m),className:"flex items-center gap-2 mt-2 text-[11px] font-semibold text-gray-500 active:text-gray-300",children:[t.jsx("div",{className:"w-5 h-px bg-gray-600"}),"View ",p," more ",p===1?"reply":"replies"]})]})]},e.id)};return t.jsx(de,{mode:"sync",children:n&&t.jsxs(t.Fragment,{children:[t.jsx(B.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-black/70 backdrop-blur-[2px] z-[9998]",onClick:()=>{_.current?.blur(),c()}}),t.jsxs(B.div,{ref:k,initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"tween",duration:.18,ease:[.32,.72,0,1]},className:"fixed inset-x-0 bottom-0 z-[9999] bg-[#0c0c0c] rounded-t-[16px] flex flex-col overflow-hidden will-change-transform shadow-[0_-14px_60px_rgba(0,0,0,0.45)] border border-white/5 border-b-0",style:{height:"calc(var(--app-height) - 96px)",maxHeight:"calc(var(--app-height) - 72px)",paddingBottom:H?"calc(env(safe-area-inset-bottom, 0px) + 12px)":q.visible?"calc(var(--keyboard-height) + env(safe-area-inset-bottom, 0px) + 10px)":"calc(env(safe-area-inset-bottom, 0px) + 12px)",transition:H?"none":"padding-bottom 0.08s linear",transform:"translateZ(0)"},children:[t.jsx("div",{className:"flex justify-center pt-3 pb-2 cursor-pointer flex-shrink-0",onClick:c,children:t.jsx("div",{className:"w-9 h-1 bg-[#555] rounded-full"})}),t.jsx("div",{className:"text-center pb-3 border-b border-[#1f1f1f] flex-shrink-0",children:t.jsx("h3",{className:"font-semibold text-white text-base tracking-tight",children:"Comments"})}),t.jsx("div",{ref:$,className:"flex-1 overflow-y-auto px-4 overscroll-contain",style:{minHeight:0,background:"linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0))"},children:b?t.jsx("div",{className:"flex justify-center py-12",children:t.jsx(O,{className:"w-6 h-6 animate-spin text-gray-400"})}):u.length===0?t.jsxs("div",{className:"text-center py-16",children:[t.jsx("div",{className:"w-20 h-20 bg-[#363636] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx(me,{className:"w-10 h-10 text-gray-500"})}),t.jsx("h3",{className:"font-semibold text-white text-xl mb-2",children:"No comments yet"}),t.jsx("p",{className:"text-sm text-gray-500",children:"Start the conversation."})]}):t.jsx("div",{className:"py-4",children:u.map(e=>ae(e))})}),t.jsxs("div",{ref:S,className:"border-t border-[#1f1f1f] bg-[#0c0c0c] flex-shrink-0 pb-[env(safe-area-inset-bottom)]",children:[t.jsx("div",{className:"flex justify-around px-6 py-3",children:ke.map(e=>t.jsx("button",{onClick:()=>ie(e),className:"text-[22px] active:scale-90 transition-transform",children:e},e))}),w&&t.jsxs("div",{className:"flex justify-between items-center px-4 py-2 bg-[#363636] mx-4 rounded-lg text-xs text-gray-400 mb-2",children:[t.jsxs("span",{children:["Replying to ",t.jsx("span",{className:"font-semibold text-white",children:w.user?.username||"User"})]}),t.jsx("button",{onClick:()=>N(null),className:"p-1",children:t.jsx(xe,{className:"w-3.5 h-3.5"})})]}),t.jsxs("div",{className:"flex items-center gap-3 px-4 pb-3",children:[t.jsx("img",{src:s.avatar_url||`https://i.pravatar.cc/150?u=${s.telegram_id}`,alt:"",className:"w-9 h-9 rounded-full object-cover flex-shrink-0 bg-[#333]"}),t.jsxs("div",{className:"flex-1 flex items-center bg-[#151515] border border-[#2e2e2e] rounded-full px-4 py-2 focus-within:border-[#444] transition-colors",children:[t.jsx("textarea",{ref:_,value:d,onChange:se,placeholder:w?"Reply...":"Add a comment...",rows:1,enterKeyHint:"send",className:"flex-1 bg-transparent text-white text-[15px] placeholder-[#888] focus:outline-none resize-none max-h-20",style:{minHeight:"22px"},onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),A())}}),d.trim()&&t.jsx("button",{onClick:A,disabled:T,className:"text-[#0095f6] font-semibold text-[15px] ml-2 disabled:opacity-50",children:T?t.jsx(O,{className:"w-5 h-5 animate-spin"}):"Post"})]})]})]})]})]})})}export{qe as C,X as E};
