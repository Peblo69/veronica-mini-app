import{c as k,r as v,ac as j,ad as N,ae as C,j as n,A as S,m as g,aa as T,ab as F,d as c}from"./index-kqTXZbKV-1765577543234.js";import{X as q}from"./x-mQahLwGG-1765577543234.js";import{C as D}from"./useInViewport-BQ4H17xA-1765577543234.js";const E=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]],B=k("grid-3x3",E);const A=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],P=k("share-2",A);function R({isOpen:e,onClose:o,userId:a,currentUserId:s,type:i,onUserClick:d}){const[f,l]=v.useState([]),[_,h]=v.useState(!0);v.useEffect(()=>{e&&x()},[e,a,i]);const x=async()=>{h(!0);const t=i==="followers"?await j(a,200):await N(a,200),u=await Promise.all(t.map(async w=>{if(w.telegram_id===s)return{...w,isFollowedByMe:!1};const r=await C(s,w.telegram_id);return{...w,isFollowedByMe:r}}));l(u),h(!1)},y=async(t,u)=>{u.stopPropagation(),l(w=>w.map(r=>r.telegram_id===t.telegram_id?{...r,followLoading:!0}:r));try{t.isFollowedByMe?(await T(s,t.telegram_id),l(w=>w.map(r=>r.telegram_id===t.telegram_id?{...r,isFollowedByMe:!1,followLoading:!1}:r))):(await F(s,t.telegram_id),l(w=>w.map(r=>r.telegram_id===t.telegram_id?{...r,isFollowedByMe:!0,followLoading:!1}:r)))}catch(w){console.error("Follow/unfollow error:",w),l(r=>r.map(b=>b.telegram_id===t.telegram_id?{...b,followLoading:!1}:b))}},m=t=>{d&&(d(t),o())};return n.jsx(S,{children:e&&n.jsxs(n.Fragment,{children:[n.jsx(g.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-black/70 backdrop-blur-sm z-[100]",onClick:o}),n.jsx(g.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},transition:{type:"spring",damping:25,stiffness:350},className:"fixed inset-0 z-[101] flex items-center justify-center p-4",onClick:o,children:n.jsxs("div",{className:"bg-[#1a1a1f] rounded-2xl w-full max-w-md overflow-hidden shadow-2xl border border-white/10",onClick:t=>t.stopPropagation(),children:[n.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-white/10",children:[n.jsx("span",{className:"text-lg font-semibold text-white capitalize",children:i}),n.jsx(g.button,{whileTap:{scale:.9},onClick:o,className:"w-9 h-9 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/15 transition-colors",children:n.jsx(q,{className:"w-5 h-5 text-white"})})]}),n.jsx("div",{className:"overflow-y-auto max-h-[70vh] min-h-[200px]",children:_?n.jsx("div",{className:"p-4 space-y-3",children:[1,2,3,4,5].map(t=>n.jsxs("div",{className:"flex items-center gap-3 animate-pulse",children:[n.jsx("div",{className:"w-12 h-12 bg-white/10 rounded-full shrink-0"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("div",{className:"h-4 bg-white/10 rounded w-28 mb-1.5"}),n.jsx("div",{className:"h-3 bg-white/10 rounded w-20"})]}),n.jsx("div",{className:"w-20 h-8 bg-white/10 rounded-lg"})]},t))}):f.length===0?n.jsx("div",{className:"py-20 text-center",children:n.jsx("p",{className:"text-white/40 text-sm",children:i==="followers"?"No followers yet":"Not following anyone"})}):n.jsx("div",{className:"p-3 space-y-1",children:f.map(t=>n.jsxs("div",{className:"w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-white/5 active:bg-white/10 transition-colors cursor-pointer",onClick:()=>m(t),children:[n.jsx("img",{src:t.avatar_url||`https://i.pravatar.cc/150?u=${t.telegram_id}`,alt:t.first_name||"User",className:"w-12 h-12 rounded-full object-cover border border-white/10 shrink-0"}),n.jsxs("div",{className:"flex-1 text-left min-w-0",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsxs("span",{className:"font-semibold text-white text-[15px] truncate",children:[t.first_name," ",t.last_name]}),t.is_verified&&n.jsx(D,{className:"w-4 h-4 text-blue-400 fill-blue-400 shrink-0"})]}),n.jsx("div",{className:"text-sm text-white/50 truncate",children:t.username?`@${t.username}`:t.is_creator?"Creator":"User"})]}),t.telegram_id!==s&&n.jsx(g.button,{whileTap:{scale:.95},onClick:u=>y(t,u),disabled:t.followLoading,className:`px-4 py-1.5 rounded-lg text-sm font-semibold transition-colors shrink-0 min-w-[90px] ${t.followLoading?"bg-white/10 text-white/50":t.isFollowedByMe?"bg-white/10 text-white hover:bg-white/15":"bg-blue-500 text-white hover:bg-blue-600"}`,children:t.followLoading?n.jsx("span",{className:"inline-block w-4 h-4 border-2 border-white/30 border-t-white/70 rounded-full animate-spin"}):t.isFollowedByMe?"Following":"Follow"})]},t.telegram_id))})})]})})]})})}function z(e){v.useEffect(()=>{if(typeof window>"u"||!e)return;const o=typeof window.requestIdleCallback=="function"?window.requestIdleCallback.bind(window):void 0,a=typeof window.cancelIdleCallback=="function"?window.cancelIdleCallback.bind(window):void 0;let s=!1,i=null,d=null;const f=()=>{if(s)return;const l=new Image;l.src=e};return o?i=o(()=>f()):d=window.setTimeout(f,250),()=>{s=!0,i!==null&&a&&a(i),d!==null&&window.clearTimeout(d)}},[e])}const p={effectiveType:"4g",saveData:!1,downlink:10};function O(){const[e,o]=v.useState(()=>{if(typeof navigator>"u")return p;const i=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return i?{effectiveType:i.effectiveType||p.effectiveType,saveData:i.saveData||!1,downlink:i.downlink||p.downlink}:p});v.useEffect(()=>{const i=navigator?.connection||navigator?.mozConnection||navigator?.webkitConnection;if(!i)return;const d=()=>{o({effectiveType:i.effectiveType||p.effectiveType,saveData:!!i.saveData,downlink:i.downlink||p.downlink})};return i.addEventListener?.("change",d),()=>i.removeEventListener?.("change",d)},[]);const a=e.effectiveType==="slow-2g"||e.effectiveType==="2g",s=e.saveData;return{...e,isSlow:a,isDataSaver:s}}async function V(e){try{const{count:o}=await c.from("follows").select("*",{count:"exact",head:!0}).eq("following_id",e),{data:a}=await c.from("posts").select("like_count, comment_count, repost_count, view_count").eq("creator_id",e),s=a?.reduce((m,t)=>m+(t.like_count||0),0)||0,i=a?.reduce((m,t)=>m+(t.comment_count||0),0)||0,d=a?.reduce((m,t)=>m+(t.repost_count||0),0)||0,{count:f}=await c.from("subscriptions").select("*",{count:"exact",head:!0}).eq("creator_id",e).eq("status","active");let l=0,_=0,h=0;try{const{count:m}=await c.from("profile_views").select("*",{count:"exact",head:!0}).eq("profile_id",e);l=m||0;const t=new Date().toISOString().split("T")[0],{count:u}=await c.from("profile_views").select("*",{count:"exact",head:!0}).eq("profile_id",e).gte("viewed_at",t);_=u||0;const w=new Date(Date.now()-10080*60*1e3).toISOString(),{count:r}=await c.from("profile_views").select("*",{count:"exact",head:!0}).eq("profile_id",e).gte("viewed_at",w);h=r||0}catch{}const x=new Date(Date.now()-10080*60*1e3).toISOString(),{count:y}=await c.from("follows").select("*",{count:"exact",head:!0}).eq("following_id",e).gte("created_at",x);return{total_followers:o||0,total_subscribers:f||0,total_posts:a?.length||0,total_likes:s,total_comments:i,total_shares:d,total_profile_views:l,views_today:_,views_this_week:h,views_this_month:h,followers_today:0,followers_this_week:y||0,total_earnings:0}}catch(o){return console.error("[Analytics] Exception:",o),null}}async function W(e,o=7){try{const a=new Date(Date.now()-o*24*60*60*1e3).toISOString(),{data:s,error:i}=await c.from("profile_views").select("viewed_at").eq("profile_id",e).gte("viewed_at",a);if(i)return console.warn("[Analytics] profile_views table not found, using fallback"),[];const d={};for(let f=0;f<o;f++){const l=new Date(Date.now()-(o-1-f)*24*60*60*1e3);d[l.toISOString().split("T")[0]]=0}return s?.forEach(f=>{const l=new Date(f.viewed_at).toISOString().split("T")[0];d[l]!==void 0&&d[l]++}),Object.entries(d).map(([f,l])=>({date:f,views:l}))}catch(a){return console.error("[Analytics] Exception:",a),[]}}async function G(e,o=10){try{const{data:a,error:s}=await c.from("profile_views").select(`
        viewer_id,
        viewed_at,
        source,
        viewer:users!profile_views_viewer_id_fkey(
          username,
          first_name,
          avatar_url,
          is_verified
        )
      `).eq("profile_id",e).not("viewer_id","is",null).neq("viewer_id",e).order("viewed_at",{ascending:!1}).limit(o);return s?(console.warn("[Analytics] Could not fetch visitors:",s.message),[]):(a||[]).map(i=>({viewer_id:i.viewer_id,username:i.viewer?.username||null,first_name:i.viewer?.first_name||null,avatar_url:i.viewer?.avatar_url||null,is_verified:i.viewer?.is_verified||!1,viewed_at:i.viewed_at,source:i.source||"feed"}))}catch(a){return console.error("[Analytics] Exception:",a),[]}}async function H(e,o=5){try{const{data:a,error:s}=await c.from("posts").select("id, content, media_url, media_type, like_count, comment_count, repost_count, view_count, created_at").eq("creator_id",e).order("like_count",{ascending:!1}).limit(o);return s?(console.error("[Analytics] Error fetching top posts:",s),[]):(a||[]).map(i=>({...i,engagement_score:(i.like_count||0)+(i.comment_count||0)*2+(i.repost_count||0)*3}))}catch(a){return console.error("[Analytics] Exception:",a),[]}}async function K(e,o,a="feed"){try{if(o&&o===e)return;await c.from("profile_views").insert({profile_id:e,viewer_id:o||null,source:a})}catch(s){console.warn("[Analytics] Failed to record view:",s)}}function Q(e,o){const a=c.channel(`profile_views_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"profile_views",filter:`profile_id=eq.${e}`},()=>o("view")).subscribe(),s=c.channel(`follows_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"follows",filter:`following_id=eq.${e}`},()=>o("follow")).subscribe(),i=c.channel(`likes_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"likes"},()=>o("like")).subscribe();return()=>{c.removeChannel(a),c.removeChannel(s),c.removeChannel(i)}}function X(e,o,a,s){if(s===0)return 0;const i=e+o*2+a*3;return Math.min(100,i/s*100)}function J(e){return e>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":e>=1e3?(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":e.toString()}function Y(e){return e>=1e3?"$"+(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":"$"+e.toFixed(2)}export{R as F,B as G,P as S,W as a,G as b,H as c,X as d,Y as e,J as f,V as g,z as h,K as r,Q as s,O as u};
