import{r as c,o as ie,p as ae,q,j as e,A as W,m as M,T as le,X as G,t as re,v as ne,w as ce,x as oe}from"./index-C5TUY2Ol-1765317247482.js";import{m as de,C as he,a as me}from"./moderation-DZOYMyVF-1765317247482.js";import{L as ue}from"./loader-circle-ddqJxM8S-1765317247482.js";import{P as xe}from"./play-r_2Ds0-9-1765317247482.js";import{I as fe}from"./image-BucUYgpE-1765317247482.js";import{C as pe}from"./camera-BuVq3odn-1765317247482.js";import{E as be}from"./ellipsis-BfNJJOfk-1765317247482.js";import{G as Q}from"./globe-Be4hdReX-1765317247482.js";import{U as X}from"./users-BEliQ0FG-1765317247482.js";import{S as J}from"./star-nt1NSoOI-1765317247482.js";function ge(t){return new Promise(g=>{const l=document.createElement("img");l.onload=()=>{g({width:l.naturalWidth,height:l.naturalHeight,sizeBytes:t.size}),URL.revokeObjectURL(l.src)},l.onerror=()=>{g({width:0,height:0,sizeBytes:t.size})},l.src=URL.createObjectURL(t)})}function we(t){return new Promise(g=>{const l=document.createElement("video");l.preload="metadata",l.onloadedmetadata=()=>{g({width:l.videoWidth,height:l.videoHeight,duration:Math.round(l.duration),sizeBytes:t.size}),URL.revokeObjectURL(l.src)},l.onerror=()=>{g({width:0,height:0,sizeBytes:t.size})},l.src=URL.createObjectURL(t)})}function Se({user:t,mode:g="media"}){const l=g==="text",[o,E]=c.useState(""),[h,w]=c.useState("public"),[K,$]=c.useState("public"),[P,S]=c.useState(!1),[F,p]=c.useState(null),[i,k]=c.useState([]),[je,j]=c.useState("idle"),[B,z]=c.useState(null),[I,U]=c.useState(!1),R=c.useRef(null),_=c.useRef(null),O=t.is_creator;c.useEffect(()=>{let s=!0;if(!O){$("public"),w("public");return}return ie(t.telegram_id).then(r=>{if(!s||!r)return;const u=r.default_post_visibility||"public";$(u),w(u)}).catch(()=>{s&&($("public"),w("public"))}),()=>{s=!1}},[t.telegram_id,O]),c.useEffect(()=>{_.current&&(_.current.style.height="auto",_.current.style.height=_.current.scrollHeight+"px")},[o]);const Y=c.useCallback(async s=>{const r=Array.from(s.target.files||[]);if(r.length===0)return;const u=4-i.length,x=r.slice(0,u);for(const f of x){const b=ae(f);if(b==="unknown")continue;j("checking"),z(null);const v=URL.createObjectURL(f);let y,N;if(b==="image")y=await ge(f);else if(b==="video"){y=await we(f);const d=await q(f);d&&(N={file:d,preview:URL.createObjectURL(d)})}const L={file:f,preview:v,type:b,metadata:y,thumbnail:N};try{{const d=b==="video"&&N?N.preview:v,a=await de(d);if(a?.flagged){j("rejected");let n="This content violates our community guidelines.";a.categories?.sexual_minors?n="This content has been flagged for safety concerns and cannot be posted.":a.categories?.sexual?n="Adult/NSFW content is not allowed.":a.categories?.violence?n="Graphic violence is not allowed.":a.categories?.self_harm?n="Self-harm content is not allowed.":a.categories?.hate?n="Hate symbols or content is not allowed.":a.reasons?.length>0&&(n=a.reasons[0]),z(n),URL.revokeObjectURL(v);continue}}j("approved"),k(d=>[...d,L])}catch(d){console.error("Moderation check failed:",d),j("approved"),k(a=>[...a,L])}}R.current&&(R.current.value="")},[i.length]),Z=s=>{k(r=>{const u=[...r],x=u.splice(s,1)[0];return x&&(URL.revokeObjectURL(x.preview),x.thumbnail?.preview&&URL.revokeObjectURL(x.thumbnail.preview)),u}),i.length===1&&(j("idle"),z(null))},ee=async()=>{if(!(P||!o.trim()&&i.length===0)){S(!0),p({message:"Preparing...",percentage:0});try{if(o.trim()&&(await me(o.trim()))?.flagged){alert("Post blocked by moderation (unsafe text)."),S(!1),p(null);return}let s,r=[],u,x,f,b,v,y;if(i.length>0){const a=i.length;for(let n=0;n<i.length;n++){const m=i[n],H=n/a*80;let V=m.file;m.type==="image"&&(p({message:`Compressing ${n+1}/${a}...`,percentage:H+10}),V=await re(V)),p({message:`Uploading ${n+1}/${a}...`,percentage:H+40});const C=await ne(V,t.telegram_id);if(C.error){alert("Upload failed: "+C.error),S(!1),p(null);return}if(C.url&&(r.push(C.url),n===0&&(s=C.url,u=m.type==="other"?"image":m.type,f=m.metadata?.width,b=m.metadata?.height,v=m.metadata?.duration,y=m.metadata?.sizeBytes)),n===0&&m.type==="video"){let T=m.thumbnail?.file;if(T||(T=await q(m.file)??void 0),T){const A=await ce(T,t.telegram_id);!A.error&&A.url&&(x=A.url)}}}}p({message:"Publishing...",percentage:90});const N=O?h:"public",L={content:o.trim(),media_url:s,media_urls:r.length>0?r:void 0,media_type:u,visibility:N,is_nsfw:!1,unlock_price:0,media_width:f,media_height:b,media_duration:v,media_size_bytes:y};x&&(L.media_thumbnail_url=x);const{error:d}=await oe(t.telegram_id,L);d?alert(`Failed to create post: ${d.message||"Please try again."}`):(p({message:"Posted!",percentage:100}),setTimeout(()=>{E(""),w(K),i.forEach(a=>{URL.revokeObjectURL(a.preview),a.thumbnail?.preview&&URL.revokeObjectURL(a.thumbnail.preview)}),k([]),j("idle"),p(null)},1e3))}catch(s){console.error("Post error:",s),alert("Something went wrong")}finally{S(!1)}}},te=()=>h==="public"?"Anyone can reply":h==="followers"?"Followers can reply":"Subscribers can reply",se=()=>h==="public"?e.jsx(Q,{className:"w-4 h-4"}):h==="followers"?e.jsx(X,{className:"w-4 h-4"}):e.jsx(J,{className:"w-4 h-4"}),D=o.trim().length>0||i.length>0;return e.jsxs("div",{className:"min-h-screen bg-black text-white flex flex-col",children:[e.jsx("input",{ref:R,type:"file",accept:"image/*,video/*",multiple:!0,className:"hidden",onChange:Y}),e.jsx(W,{children:F&&e.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/90 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"w-16 h-16 mx-auto mb-4 relative",children:[e.jsxs("svg",{className:"w-16 h-16 transform -rotate-90",children:[e.jsx("circle",{cx:"32",cy:"32",r:"28",stroke:"rgba(255,255,255,0.1)",strokeWidth:"4",fill:"none"}),e.jsx("circle",{cx:"32",cy:"32",r:"28",stroke:"white",strokeWidth:"4",fill:"none",strokeDasharray:175.9,strokeDashoffset:175.9-175.9*F.percentage/100,className:"transition-all duration-300"})]}),e.jsxs("span",{className:"absolute inset-0 flex items-center justify-center text-sm font-bold",children:[Math.round(F.percentage),"%"]})]}),e.jsx("p",{className:"text-white/60 text-sm",children:F.message})]})})}),e.jsx(W,{children:B&&e.jsxs(M.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"fixed top-4 left-4 right-4 z-40 bg-red-500/90 backdrop-blur-sm rounded-xl p-4 flex items-start gap-3",children:[e.jsx(le,{className:"w-5 h-5 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-sm font-medium",children:B})}),e.jsx("button",{onClick:()=>z(null),className:"p-1",children:e.jsx(G,{className:"w-4 h-4"})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/10",children:[e.jsx("button",{onClick:()=>{E(""),i.forEach(s=>{URL.revokeObjectURL(s.preview),s.thumbnail?.preview&&URL.revokeObjectURL(s.thumbnail.preview)}),k([]),j("idle"),window.history.back()},className:"text-white/60 text-[15px] font-medium",children:"Cancel"}),e.jsx("span",{className:"text-white text-[16px] font-semibold",children:l?"Quick thought":"New post"}),e.jsx("button",{onClick:ee,disabled:!D||P,className:`px-5 py-1.5 rounded-full text-[14px] font-semibold transition-all ${D&&!P?"bg-white text-black":"bg-white/10 text-white/30"}`,children:P?e.jsx(ue,{className:"w-4 h-4 animate-spin"}):"Post"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-white/10 flex-shrink-0",children:t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:t.first_name||t.username||"User",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-white/60 text-base font-semibold",children:(t.first_name||t.username||"U")[0].toUpperCase()})}),(o.length>0||i.length>0)&&e.jsx("div",{className:"w-0.5 bg-white/10 flex-1 mt-2 min-h-[20px]"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("span",{className:"text-white text-[16px] font-semibold",children:t.first_name||t.username||"User"})}),e.jsx("textarea",{ref:_,value:o,onChange:s=>E(s.target.value.slice(0,500)),placeholder:"What's on your mind?",className:"w-full bg-transparent text-white text-[17px] placeholder-white/40 resize-none focus:outline-none min-h-[80px] leading-relaxed",rows:1}),i.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:`grid gap-2 ${i.length===1?"grid-cols-1":(i.length===2||i.length===3,"grid-cols-2")}`,children:i.map((s,r)=>e.jsxs("div",{className:`relative overflow-hidden rounded-2xl ${i.length===1?"aspect-[4/3]":i.length===3&&r===0?"row-span-2 aspect-auto h-full":"aspect-square"}`,style:{background:"rgba(255, 255, 255, 0.03)",border:"1px solid rgba(255, 255, 255, 0.08)"},children:[s.type==="image"?e.jsx("img",{src:s.preview,alt:"preview",className:"w-full h-full object-cover"}):e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("img",{src:s.thumbnail?.preview||s.preview,alt:"preview",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-14 h-14 rounded-full flex items-center justify-center",style:{background:"rgba(0, 0, 0, 0.6)",backdropFilter:"blur(10px)",border:"2px solid rgba(255, 255, 255, 0.2)"},children:e.jsx(xe,{className:"w-6 h-6 text-white ml-1",fill:"white"})})}),s.metadata?.duration&&e.jsxs("div",{className:"absolute bottom-2 right-2 px-2 py-0.5 rounded-md text-[11px] font-medium text-white",style:{background:"rgba(0, 0, 0, 0.7)"},children:[Math.floor(s.metadata.duration/60),":",String(s.metadata.duration%60).padStart(2,"0")]})]}),e.jsx("button",{onClick:()=>Z(r),className:"absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center active:scale-95 transition-transform",style:{background:"rgba(0, 0, 0, 0.6)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.15)"},children:e.jsx(G,{className:"w-4 h-4 text-white"})}),i.length>1&&r===0&&e.jsxs("div",{className:"absolute top-2 left-2 px-2 py-1 rounded-full text-[11px] font-semibold text-white",style:{background:"rgba(0, 0, 0, 0.6)",backdropFilter:"blur(10px)"},children:["1/",i.length]})]},r))})}),!l&&e.jsxs("div",{className:"flex items-center gap-5 mt-4",children:[e.jsx("button",{onClick:()=>R.current?.click(),disabled:i.length>=4,className:"w-11 h-11 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-white/50 hover:text-white/70 hover:bg-white/10 transition-all disabled:opacity-30 active:scale-95",children:e.jsx(fe,{className:"w-6 h-6"})}),e.jsx("button",{onClick:()=>R.current?.click(),disabled:i.length>=4,className:"w-11 h-11 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-white/50 hover:text-white/70 hover:bg-white/10 transition-all disabled:opacity-30 active:scale-95",children:e.jsx(pe,{className:"w-6 h-6"})}),e.jsx("button",{className:"w-11 h-11 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-white/50 hover:text-white/70 hover:bg-white/10 transition-all active:scale-95",children:e.jsx(be,{className:"w-6 h-6"})})]}),o.length>400&&e.jsx("div",{className:"mt-3",children:e.jsxs("span",{className:`text-xs ${o.length>480?"text-orange-400":"text-white/30"}`,children:[o.length,"/500"]})})]})]}),(o.length>0||i.length>0)&&e.jsxs("div",{className:"flex items-center gap-3 mt-4",children:[e.jsx("div",{className:"w-12 flex justify-center",children:e.jsx("div",{className:"w-7 h-7 rounded-full overflow-hidden bg-white/5 border border-white/10 flex items-center justify-center",children:t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:"",className:"w-full h-full object-cover opacity-60"}):e.jsx("div",{className:"text-white/30 text-[10px] font-semibold",children:(t.first_name||t.username||"U")[0].toUpperCase()})})}),e.jsx("span",{className:"text-white/30 text-[15px]",children:"Add to post..."})]})]})}),e.jsx("div",{className:"border-t border-white/10 px-4 py-3",children:e.jsxs("button",{onClick:()=>U(!I),className:"flex items-center gap-2 text-white/50 text-[14px]",children:[se(),e.jsx("span",{children:te()}),e.jsx(he,{className:"w-4 h-4"})]})}),e.jsx(W,{children:I&&e.jsxs(e.Fragment,{children:[e.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/60 z-40",onClick:()=>U(!1)}),e.jsxs(M.div,{initial:{opacity:0,y:100},animate:{opacity:1,y:0},exit:{opacity:0,y:100},className:"fixed bottom-0 left-0 right-0 bg-[#1c1c1e] rounded-t-2xl z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"w-10 h-1 bg-white/20 rounded-full mx-auto mb-4"}),e.jsx("h3",{className:"text-white text-lg font-semibold text-center mb-4",children:"Who can reply?"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>{w("public"),U(!1)},className:`w-full flex items-center gap-3 p-4 rounded-xl transition-colors ${h==="public"?"bg-white/10":"bg-transparent"}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/10 flex items-center justify-center",children:e.jsx(Q,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"text-white font-medium",children:"Anyone"}),e.jsx("p",{className:"text-white/50 text-sm",children:"Anyone can reply to your post"})]}),h==="public"&&e.jsx("div",{className:"w-6 h-6 rounded-full bg-white flex items-center justify-center",children:e.jsx("div",{className:"w-2 h-2 rounded-full bg-black"})})]}),e.jsxs("button",{onClick:()=>{w("followers"),U(!1)},className:`w-full flex items-center gap-3 p-4 rounded-xl transition-colors ${h==="followers"?"bg-white/10":"bg-transparent"}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/10 flex items-center justify-center",children:e.jsx(X,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"text-white font-medium",children:"Followers"}),e.jsx("p",{className:"text-white/50 text-sm",children:"Only people who follow you"})]}),h==="followers"&&e.jsx("div",{className:"w-6 h-6 rounded-full bg-white flex items-center justify-center",children:e.jsx("div",{className:"w-2 h-2 rounded-full bg-black"})})]}),O&&e.jsxs("button",{onClick:()=>{w("subscribers"),U(!1)},className:`w-full flex items-center gap-3 p-4 rounded-xl transition-colors ${h==="subscribers"?"bg-white/10":"bg-transparent"}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/10 flex items-center justify-center",children:e.jsx(J,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"text-white font-medium",children:"Subscribers"}),e.jsx("p",{className:"text-white/50 text-sm",children:"Only your paid subscribers"})]}),h==="subscribers"&&e.jsx("div",{className:"w-6 h-6 rounded-full bg-white flex items-center justify-center",children:e.jsx("div",{className:"w-2 h-2 rounded-full bg-black"})})]})]})]}),e.jsx("div",{className:"h-8"})," "]})]})})]})}export{Se as default};
