import{c as G,ac as K,r as o,j as e,m as k,A as $,C as Q,u as Z,l as F,h as ee,f as te,ad as se,d as ae}from"./index-M-X0SRHO-1765412432810.js";import{P as ne,a as ie,b as le,c as re,d as oe,C as ce,V as de}from"./CommentsSheet-DptNxJRO-1765412432810.js";import{A as me}from"./arrow-left-CNWHf0qW-1765412432810.js";import{E as ue}from"./ellipsis-Bk7mMoOL-1765412432810.js";import{T as W}from"./trash-2-BFE1rTJP-1765412432810.js";import{L as xe}from"./lock-BE7oSGeC-1765412432810.js";import{L as V}from"./loader-circle-D_YmwZUd-1765412432810.js";import{V as he}from"./volume-2-DpLUi0Sq-1765412432810.js";import{H as fe}from"./heart-Cm5vH_aL-1765412432810.js";const pe=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],be=G("pen",pe),we="https://eigfbxjheuwxmtdfnvqc.supabase.co/functions/v1/payments";async function _(s){const a=K();return a?.accessToken?(await fetch(we,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.accessToken}`},body:JSON.stringify(s)})).json():{error:"Not authenticated - please log in again"}}async function ge(s,a){return _({action:"create_unlock_invoice",user_id:s,post_id:a})}async function je(s,a,c,d,n){return _({action:"create_tip_invoice",user_id:s,to_user_id:a,amount:c,message:d,post_id:n})}async function Me(s){return _({action:"get_wallet",user_id:s})}async function ve(s,a){return _({action:"check_purchase",user_id:s,post_id:a})}function z(s,a,c,d){const n=window.Telegram?.WebApp;if(!n){console.error("Telegram WebApp not available"),c?.();return}n.openInvoice(s,t=>{switch(console.log("Invoice status:",t),t){case"paid":a?.();break;case"cancelled":case"failed":c?.();break;case"pending":d?.();break;default:console.log("Unknown invoice status:",t)}})}async function Ee(s,a,c,d){try{const n=await ge(s,a);if(n.error){d?.(n.error);return}if(!n.invoice_link){d?.("Failed to create invoice");return}z(n.invoice_link,async()=>{let t=!1;for(let l=0;l<10;l++)if(await new Promise(h=>setTimeout(h,500)),(await ve(s,a)).purchased){t=!0;break}t||console.warn("[Payment] Purchase not verified yet, but Telegram confirmed payment"),c?.()},()=>d?.("Payment was cancelled"),()=>console.log("Payment pending..."))}catch(n){console.error("Unlock payment error:",n),d?.("An error occurred")}}async function Ie(s,a,c,d,n,t,l){try{const x=await je(s,a,c,d,n);if(x.error){l?.(x.error);return}if(!x.invoice_link){l?.("Failed to create invoice");return}z(x.invoice_link,t,()=>l?.("Payment was cancelled"),()=>console.log("Payment pending..."))}catch(x){console.error("Tip payment error:",x),l?.("An error occurred")}}function ye({urls:s,muted:a,onMuteChange:c,onDoubleTap:d}){const[n,t]=o.useState(0),l=o.useRef(null),x=o.useRef(null),[h,w]=o.useState(!1),p=o.useRef(0),v=()=>{if(!l.current)return;const m=l.current.scrollLeft,u=l.current.offsetWidth,b=Math.round(m/u);b!==n&&t(b)},g=()=>{const m=Date.now();m-p.current<300&&(d?.(),w(!0),setTimeout(()=>w(!1),500)),p.current=m},f=m=>m.match(/\.(mp4|webm|mov|m4v)(\?|$)/i);return s.length===0?null:e.jsxs("div",{className:"relative w-full bg-black",children:[e.jsx("div",{ref:l,className:"flex w-full overflow-x-auto snap-x snap-mandatory scrollbar-hide",onScroll:v,style:{scrollbarWidth:"none",msOverflowStyle:"none"},onClick:g,children:s.map((m,u)=>e.jsx("div",{className:"flex-none w-full snap-center flex items-center justify-center min-h-[220px] max-h-[50vh]",children:f(m)?e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("video",{ref:u===n?x:void 0,src:m,controls:!1,playsInline:!0,loop:!0,muted:a,autoPlay:n===u,preload:"auto",className:"w-full max-h-[50vh] object-contain bg-black"}),e.jsx("button",{onClick:b=>{b.stopPropagation(),c?.(!a)},className:"absolute bottom-3 right-3 p-2 bg-black/70 rounded-full",children:a?e.jsx(de,{className:"w-5 h-5 text-white"}):e.jsx(he,{className:"w-5 h-5 text-white"})})]}):e.jsx("img",{src:m,alt:"",loading:"eager",className:"w-full max-h-[50vh] object-contain bg-black select-none"})},u))}),h&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx(fe,{className:"w-16 h-16 text-white fill-white opacity-90 animate-ping"})}),s.length>1&&e.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1.5 z-10",children:s.map((m,u)=>e.jsx("div",{className:`w-1.5 h-1.5 rounded-full transition-all ${u===n?"bg-white":"bg-white/40"}`},u))}),s.length>1&&e.jsxs("div",{className:"absolute top-2 right-2 bg-black/70 text-white text-[10px] px-2 py-0.5 rounded-full z-10 font-medium",children:[n+1,"/",s.length]})]})}function Le({post:s,user:a,onBack:c,onDeleted:d,onUpdated:n}){const[t,l]=o.useState(s),[x,h]=o.useState(!1),[w,p]=o.useState(!1),[v,g]=o.useState(!1),[f,m]=o.useState(s.content||""),[u,b]=o.useState(s.visibility),[C,S]=o.useState(!1),[T,D]=o.useState(!1),[R,y]=o.useState(!1),[A,j]=o.useState(null),[H,O]=o.useState(!0),B=Number(s.creator_id)===Number(a.telegram_id),M=t.media_urls&&t.media_urls.length>0?t.media_urls:t.media_url?[t.media_url]:[],E=async()=>{t.liked?(await Z(a.telegram_id,t.id),l(i=>{const r={...i,liked:!1,likes_count:Math.max(0,(i.likes_count||0)-1)};return n?.(r),r})):(await F(a.telegram_id,t.id),l(i=>{const r={...i,liked:!0,likes_count:(i.likes_count||0)+1};return n?.(r),r}))},U=async()=>{t.saved?(await ee(a.telegram_id,t.id),l(i=>{const r={...i,saved:!1};return n?.(r),r})):(await te(a.telegram_id,t.id),l(i=>{const r={...i,saved:!0};return n?.(r),r}))},q=async()=>{if(!f.trim())return;D(!0);const{data:i,error:r}=await se(t.id,a.telegram_id,{content:f,visibility:u});i&&!r&&(l(I=>({...I,content:f,visibility:u})),g(!1),n?.({...t,content:f,visibility:u})),D(!1)},J=async()=>{S(!0),j(null);try{const{success:i}=await ae(t.id,t.creator_id);i?(y(!1),d?.(),c()):j("Unable to delete post. Please try again.")}catch{j("Something went wrong. Please try again.")}S(!1)},X=i=>{const r=new Date(i),Y=new Date().getTime()-r.getTime(),N=Math.floor(Y/6e4),P=Math.floor(N/60),L=Math.floor(P/24);return N<1?"now":N<60?`${N}m`:P<24?`${P}h`:L<7?`${L}d`:r.toLocaleDateString("en-US",{month:"short",day:"numeric"})};return e.jsxs(k.div,{className:"fixed inset-0 bg-black z-[100] flex flex-col",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15},children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-black",style:{paddingTop:"max(60px, calc(env(safe-area-inset-top, 0px) + 50px))"},children:[e.jsxs("button",{onClick:c,className:"flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors",children:[e.jsx(me,{className:"w-5 h-5 text-white"}),e.jsx("span",{className:"text-white text-sm font-medium",children:"Back"})]}),B?e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>p(!w),className:"p-2 hover:bg-white/10 rounded-full transition-colors",children:e.jsx(ue,{className:"w-5 h-5 text-white"})}),e.jsx($,{children:w&&e.jsxs(k.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.1},className:"absolute right-0 top-10 bg-[#1c1c1e] shadow-xl rounded-xl py-1 z-20 min-w-[120px] border border-white/10",children:[e.jsxs("button",{onClick:()=>{g(!0),p(!1)},className:"w-full px-3 py-2 text-left text-sm hover:bg-white/10 flex items-center gap-2 text-white",children:[e.jsx(be,{className:"w-4 h-4"})," Edit"]}),e.jsxs("button",{onClick:()=>{y(!0),p(!1)},className:"w-full px-3 py-2 text-left text-sm text-red-400 hover:bg-red-500/10 flex items-center gap-2",children:[e.jsx(W,{className:"w-4 h-4"})," Delete"]})]})})]}):e.jsx("div",{className:"w-10"})]}),e.jsxs("div",{className:"flex items-center gap-3 px-4 pb-2",children:[e.jsx("img",{src:t.creator?.avatar_url||`https://i.pravatar.cc/150?u=${t.creator_id}`,alt:"",className:"w-9 h-9 rounded-full object-cover border border-white/10"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"font-semibold text-sm text-white",children:t.creator?.username||"Creator"}),t.creator?.is_verified&&e.jsx(Q,{className:"w-3.5 h-3.5 text-blue-400 fill-blue-400"}),t.visibility!=="public"&&e.jsx(xe,{className:"w-3 h-3 text-white/50"})]}),e.jsx("span",{className:"text-white/50 text-xs",children:X(t.created_at)})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto bg-black",children:[M.length>0&&e.jsx(ye,{urls:M,muted:H,onMuteChange:O,onDoubleTap:E}),!v&&t.content&&e.jsx("p",{className:"px-4 py-2 text-sm leading-relaxed text-white/90 whitespace-pre-wrap",children:t.content}),v&&e.jsxs("div",{className:"p-3 space-y-2 bg-[#0a0a0a] border-y border-white/5",children:[e.jsx("textarea",{value:f,onChange:i=>m(i.target.value),className:"w-full p-2 border border-white/10 rounded-lg min-h-[80px] focus:outline-none focus:border-white/20 bg-black text-xs text-white placeholder-white/30",placeholder:"What's on your mind?"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:u,onChange:i=>b(i.target.value),className:"px-2 py-1.5 border border-white/10 rounded-lg bg-black text-xs text-white outline-none",children:[e.jsx("option",{value:"public",children:"Public"}),e.jsx("option",{value:"followers",children:"Followers"}),e.jsx("option",{value:"subscribers",children:"Subscribers"})]}),e.jsxs("div",{className:"flex-1 flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>g(!1),className:"px-3 py-1.5 border border-white/10 rounded-lg text-xs font-medium hover:bg-white/5 transition-colors text-white",children:"Cancel"}),e.jsx("button",{onClick:q,disabled:T,className:"px-3 py-1.5 bg-blue-500 text-white rounded-lg text-xs font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center min-w-[50px]",children:T?e.jsx(V,{className:"w-3 h-3 animate-spin"}):"Save"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-white/5",children:[e.jsxs("div",{className:"flex items-center gap-5",children:[e.jsxs("button",{onClick:E,className:`flex items-center gap-1.5 transition-colors ${t.liked?"text-red-500":"text-white/70"}`,children:[e.jsx(ne,{className:`w-6 h-6 ${t.liked?"scale-110":""}`,filled:t.liked}),e.jsx("span",{className:"text-sm font-medium",children:t.likes_count||0})]}),e.jsxs("button",{onClick:()=>h(!0),className:"flex items-center gap-1.5 text-white/70",children:[e.jsx(ie,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm font-medium",children:t.comments_count||0})]}),e.jsx("button",{className:"text-white/70",children:e.jsx(le,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:U,className:`transition-colors ${t.saved?"text-blue-400":"text-white/70"}`,children:e.jsx(re,{className:"w-6 h-6",filled:t.saved})}),e.jsxs("button",{className:"flex items-center gap-1",children:[e.jsx(oe,{className:`w-6 h-6 ${(t.gifts_count||0)>0?"text-yellow-400":"text-white/70"}`,filled:(t.gifts_count||0)>0}),(t.gifts_count||0)>0&&e.jsx("span",{className:"text-xs font-bold text-yellow-400",children:t.gifts_count})]})]})]}),e.jsx("button",{onClick:()=>h(!0),className:"w-full px-4 py-3 text-left",children:t.comments_count>0?e.jsxs("span",{className:"text-white/50 text-sm font-medium",children:["View all ",t.comments_count," comments"]}):e.jsx("span",{className:"text-white/50 text-sm",children:"Add a comment..."})})]}),e.jsx(ce,{isOpen:x,onClose:()=>h(!1),postId:t.id,user:a}),e.jsx($,{children:R&&e.jsx(k.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15},className:"fixed inset-0 bg-black/80 flex items-center justify-center z-[120] p-4",onClick:()=>{y(!1),j(null)},children:e.jsxs(k.div,{initial:{scale:.95},animate:{scale:1},exit:{scale:.95},transition:{duration:.15},className:"bg-[#1c1c1e] rounded-2xl p-5 max-w-xs w-full border border-white/10",onClick:i=>i.stopPropagation(),children:[e.jsx("div",{className:"w-10 h-10 bg-red-500/10 rounded-full flex items-center justify-center mb-3 mx-auto",children:e.jsx(W,{className:"w-5 h-5 text-red-400"})}),e.jsx("h3",{className:"text-base font-bold mb-1.5 text-center text-white",children:"Delete Post?"}),e.jsx("p",{className:"text-white/50 mb-3 text-center text-xs",children:"This action cannot be undone."}),A&&e.jsx("div",{className:"mb-3 p-2 bg-red-500/10 border border-red-500/20 rounded-xl",children:e.jsx("p",{className:"text-red-400 text-xs text-center",children:A})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{y(!1),j(null)},className:"flex-1 py-2 border border-white/10 rounded-xl font-medium text-white text-sm",disabled:C,children:"Cancel"}),e.jsx("button",{onClick:J,disabled:C,className:"flex-1 py-2 bg-red-500 text-white rounded-xl font-semibold text-sm flex items-center justify-center disabled:opacity-50",children:C?e.jsx(V,{className:"w-4 h-4 animate-spin"}):"Delete"})]})]})})})]})}export{Le as P,Me as g,Ie as s,Ee as u};
